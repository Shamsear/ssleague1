{% extends "base.html" %}

{% block title %}Manage Rounds - Auction System{% endblock %}

{% block content %}
<div class="container mx-auto px-2 sm:px-4 py-3 sm:py-6">
    <div class="glass rounded-3xl p-3 sm:p-6 mb-3 backdrop-blur-md">
        <div class="flex flex-col gap-3 mb-3">
            <h2 class="text-xl sm:text-2xl font-bold text-dark gradient-text">Round Management</h2>
            
            <!-- Navigation Links -->
            <div class="flex flex-wrap gap-2">
                <a href="{{ url_for('dashboard') }}" class="inline-flex items-center px-4 py-2.5 rounded-xl bg-white/60 text-gray-700 hover:bg-white/80 transition-all duration-200 backdrop-blur-sm border border-gray-200/50 touch-action-manipulation">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1h3m-9 0h3" />
                </svg>
                    Dashboard
                </a>
            </div>
        </div>
        
        <!-- Create New Round Section -->
        <div class="glass rounded-2xl p-3 sm:p-6 mb-4 border border-gray-100/20 transform transition-all duration-300 hover:shadow-lg backdrop-blur-sm">
            <h2 class="text-lg sm:text-xl font-bold mb-3 gradient-text">Start New Round</h2>
            <form id="startRoundForm" class="space-y-3">
                <div>
                    <label for="position" class="block text-sm font-medium text-gray-700 mb-1.5">Position</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-gray-400">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z" />
                            </svg>
                        </span>
                        <select id="position" name="position" required
                            class="pl-10 w-full py-3 bg-white/60 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all duration-200 text-base">
                            {% for position in config.POSITIONS %}
                            <option value="{{ position }}">{{ position }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div>
                    <label for="duration" class="block text-sm font-medium text-gray-700 mb-1.5">Duration (seconds)</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-gray-400">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </span>
                        <input type="number" id="duration" name="duration" value="300" min="30" required
                            class="pl-10 w-full py-3 bg-white/60 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all duration-200 text-base">
                    </div>
                    <p class="mt-1 text-xs text-gray-500">Minimum 30 seconds</p>
                </div>
                
                <div>
                    <label for="max_bids_per_team" class="block text-sm font-medium text-gray-700 mb-1.5">Max Bids Per Team</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-gray-400">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                        </span>
                        <input type="number" id="max_bids_per_team" name="max_bids_per_team" value="5" min="1" required
                            class="pl-10 w-full py-3 bg-white/60 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all duration-200 text-base">
                    </div>
                    <p class="mt-1 text-xs text-gray-500">Maximum number of players each team can bid on in this round</p>
                </div>
                
                <button type="submit"
                    class="w-full py-3 rounded-xl bg-gradient-to-r from-primary to-secondary text-white font-medium hover:from-primary/90 hover:to-secondary/90 transform hover:scale-[1.01] active:scale-[0.99] transition-all duration-200 shadow-md">
                    Start Round
                </button>
            </form>
        </div>

        <!-- Active Rounds Section -->
        <div class="glass rounded-2xl p-3 sm:p-6 mb-4 border border-gray-100/20 backdrop-blur-sm">
            <h2 class="text-lg sm:text-xl font-bold mb-4 gradient-text flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                Active Rounds
            </h2>
            <div id="activeRounds" class="space-y-4">
                {% for round in active_rounds %}
                <div class="glass rounded-xl p-4 border border-gray-200/30 transform transition-all duration-300 hover:shadow-lg backdrop-blur-sm" data-round-id="{{ round.id }}">
                    <div class="flex flex-col justify-between items-start gap-3 mb-3">
                        <div class="flex items-center justify-between w-full">
                            <div class="flex items-center">
                                <div class="w-2 h-2 rounded-full bg-green-500 mr-2 animate-pulse"></div>
                                <h3 class="text-base sm:text-lg font-semibold">{{ round.position }} Round</h3>
                            </div>
                            <div class="text-sm font-medium px-3 py-1.5 rounded-xl bg-white/80 backdrop-blur-sm shadow-sm" id="timer-{{ round.id }}">
                                <span id="timer-remaining-{{ round.id }}" class="font-mono">--:--</span>
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap gap-3 w-full mt-2">
                            <div class="flex items-center gap-2 p-2 bg-white/50 rounded-xl backdrop-blur-sm flex-1 min-w-[180px]">
                                <div class="relative flex-1 max-w-[100px]">
                                    <input type="number" id="update-duration-{{ round.id }}" min="30" value="{{round.duration}}"
                                        class="w-full py-2.5 px-3 rounded-xl bg-white border border-gray-200 focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none text-base">
                                    <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-xs text-gray-500">sec</span>
                                </div>
                                <button onclick="updateRoundTimer({{ round.id }})"
                                    class="bg-primary/90 text-white px-3 py-2.5 rounded-xl hover:bg-primary transition-all duration-200 text-sm whitespace-nowrap">
                                    Update Timer
                                </button>
                            </div>
                            <button onclick="finalizeRound({{ round.id }})"
                                class="bg-green-500 text-white px-4 py-2.5 rounded-xl hover:bg-green-600 transition-all duration-200 flex-1 min-w-[180px] font-medium">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                                Finalize Round
                            </button>
                        </div>
                    </div>

                    {% if round.status == "processing" %}
                    <div class="mt-3 glass rounded-xl border-l-4 border-yellow-400 p-3 backdrop-blur-sm bg-yellow-50/70">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-yellow-700">
                                    <strong>Round in processing.</strong> Resolve tiebreakers first.
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <div class="text-center py-6 glass rounded-xl bg-white/40 backdrop-blur-sm border border-gray-100/20">
                    <svg class="w-12 h-12 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <h3 class="mt-2 text-base font-medium text-gray-600">No active rounds</h3>
                    <p class="mt-1 text-sm text-gray-500">Start a new round using the form above</p>
                    <button onclick="document.getElementById('startRoundForm').querySelector('button').scrollIntoView({ behavior: 'smooth' })"
                        class="mt-3 px-4 py-2 bg-primary/90 text-white rounded-xl hover:bg-primary text-sm transition-all duration-200">
                        Start Round
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Active Tiebreakers Section (if any) -->
        {% if active_tiebreakers %}
        <div class="glass rounded-2xl p-3 sm:p-6 mb-4 border border-gray-100/20 backdrop-blur-sm">
            <h2 class="text-lg sm:text-xl font-bold mb-3 gradient-text">Active Tiebreakers</h2>
            <div class="space-y-4">
                {% for tiebreaker in active_tiebreakers %}
                <div class="glass rounded-xl p-3 sm:p-4 border border-gray-200/30 transform transition-all duration-300 hover:shadow-lg">
                    <div class="flex flex-col gap-3 mb-3">
                        <h3 class="text-base sm:text-lg font-semibold line-clamp-2">
                            Tiebreaker: {{ tiebreaker.player.name }}
                        </h3>
                        <div class="flex flex-wrap gap-2 items-center justify-between">
                            <div class="glass rounded-xl px-3 py-2 backdrop-blur-sm inline-flex items-center">
                                <span class="text-sm font-medium mr-2">Round #{{ tiebreaker.round.id }}</span>
                            </div>
                            <a href="{{ url_for('get_tiebreaker', tiebreaker_id=tiebreaker.id) }}" 
                               class="bg-primary text-white px-4 py-2.5 rounded-xl hover:bg-primary/90 transition-all duration-200 transform hover:scale-[1.01] active:scale-[0.99] inline-flex items-center">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                                View
                            </a>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                        <div class="glass rounded-xl p-3 backdrop-blur-sm">
                            <h4 class="font-medium mb-1 text-sm text-gray-600">Original Bid</h4>
                            <p class="text-lg font-bold">{{ tiebreaker.original_amount }}</p>
                        </div>
                        <div class="glass rounded-xl p-3 backdrop-blur-sm">
                            <h4 class="font-medium mb-1 text-sm text-gray-600">Status</h4>
                            <p>
                                {% set submitted = tiebreaker.team_tiebreakers|selectattr('new_amount', 'defined')|list|length %}
                                {% set total = tiebreaker.team_tiebreakers|length %}
                                <span class="px-3 py-1.5 inline-flex text-xs leading-5 font-semibold rounded-full {% if submitted == total %}bg-green-100 text-green-800{% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                    {{ submitted }} of {{ total }} teams submitted
                                </span>
                            </p>
                        </div>
                    </div>
                    
                    <div class="glass rounded-xl p-3 backdrop-blur-sm">
                        <h4 class="font-medium mb-2 text-gray-700">Tied Teams</h4>
                        <ul class="divide-y divide-gray-100/30">
                            {% for team_tiebreaker in tiebreaker.team_tiebreakers %}
                            <li class="flex justify-between items-center py-2.5">
                                <span class="text-sm truncate mr-1">{{ team_tiebreaker.team.name }}</span>
                                <span class="text-sm {% if team_tiebreaker.new_amount %}text-green-600{% else %}text-orange-600{% endif %} px-2 py-1 rounded-lg bg-white/40 whitespace-nowrap">
                                    {% if team_tiebreaker.new_amount %}
                                    Bid: {{ team_tiebreaker.new_amount }}
                                    {% else %}
                                    Waiting
                                    {% endif %}
                        </span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Round Results Section -->
        <div class="glass rounded-2xl p-3 sm:p-6 border border-gray-100/20 backdrop-blur-sm">
            <h2 class="text-lg sm:text-xl font-bold mb-4 gradient-text flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                </svg>
                Round Results
            </h2>
            <div class="space-y-4">
                {% for round in rounds|sort(attribute='id', reverse=true) %}
                {% if not round.is_active %}
                <div class="glass rounded-xl p-4 border border-gray-200/30 transform transition-all duration-300 hover:shadow-lg backdrop-blur-sm">
                    <div class="flex flex-col gap-3 mb-3">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center">
                                <span class="w-2 h-2 rounded-full bg-gray-400 mr-2"></span>
                                <h3 class="text-base font-semibold">{{ round.position }} Round</h3>
                            </div>
                            <span class="text-xs text-gray-500 bg-gray-100/80 px-2 py-1 rounded-lg">Round #{{ round.id }}</span>
                        </div>

                        <div class="flex flex-wrap justify-between items-center gap-2">
                            <div class="flex flex-col gap-1">
                                <p class="text-xs text-gray-600 bg-white/40 px-2 py-1 rounded-lg">
                                    <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                    {{ round.start_time.strftime('%Y-%m-%d %H:%M') }}
                                </p>
                                {% if round.players|selectattr('team_id')|list|length > 0 %}
                                <p class="text-xs text-green-600 bg-green-50/60 px-2 py-1 rounded-lg">
                                    <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                    </svg>
                                    {{ round.players|selectattr('team_id')|list|length }} players allocated
                                </p>
                                {% endif %}
                            </div>
                            <div class="flex gap-2">
                                <a href="{{ url_for('admin_round_detail', round_id=round.id) }}" 
                                   class="inline-flex items-center px-3 py-2 rounded-xl bg-primary/90 text-white hover:bg-primary transition-all duration-200 transform hover:scale-[1.01] active:scale-[0.99] text-sm">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                    </svg>
                                    View Details
                                </a>
                                <button onclick="deleteRound({{ round.id }})" 
                                    class="inline-flex items-center px-3 py-2 rounded-xl bg-red-500/90 text-white hover:bg-red-600 transition-all duration-200 transform hover:scale-[1.01] active:scale-[0.99] text-sm">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mobile-friendly card view instead of tables -->
                    <div class="mb-3 mt-2">
                        <h4 class="font-medium text-gray-700 mb-2 flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                            </svg>
                            Final Allocations
                        </h4>
                        <div class="space-y-2 bg-white/30 p-3 rounded-xl backdrop-blur-sm">
                            {% if round.players|selectattr('team_id')|list %}
                                {% for player in round.players %}
                                    {% if player.team_id %}
                                    <div class="glass rounded-lg p-2.5 backdrop-blur-sm border border-gray-100/30 hover:shadow-sm transition-all duration-200">
                                        <div class="flex justify-between items-center">
                                            <div class="truncate mr-2">
                                                <div class="text-sm font-medium">{{ player.name }}</div>
                                                <div class="text-xs text-gray-500">{{ player.position }}</div>
                                            </div>
                                            <div class="flex flex-col items-end text-right">
                                                <div class="text-xs px-2 py-0.5 bg-primary/10 rounded-lg">{{ player.team.name }}</div>
                                                <div class="text-sm font-bold mt-1">
                                                    {% for bid in player.bids %}
                                                        {% if bid.team_id == player.team_id %}
                                                            {{ "{:,}".format(bid.amount) }}
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                <div class="text-center py-4 glass rounded-lg bg-white/30 text-sm text-gray-500 italic">
                                    No players allocated
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="flex justify-center mt-3">
                        <a href="{{ url_for('admin_round_detail', round_id=round.id) }}" class="text-primary text-sm flex items-center hover:underline">
                            <span>See all bids and details</span>
                            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                            </svg>
                        </a>
                    </div>
                </div>
                {% endif %}
                {% else %}
                <div class="text-center py-6 glass rounded-xl bg-white/40 backdrop-blur-sm border border-gray-100/20">
                    <svg class="w-12 h-12 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                    </svg>
                    <h3 class="mt-2 text-base font-medium text-gray-600">No completed rounds yet</h3>
                    <p class="mt-1 text-sm text-gray-500">Past rounds will appear here once they're finalized</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('startRoundForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const position = document.getElementById('position').value;
    const duration = document.getElementById('duration').value;
    const max_bids_per_team = document.getElementById('max_bids_per_team').value;
    
    try {
        const response = await fetch('/start_round', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
            body: JSON.stringify({ position, duration, max_bids_per_team }),
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to start round');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred');
    }
});

async function updateRoundTimer(roundId) {
    const duration = document.getElementById(`update-duration-${roundId}`).value;
    
    try {
        const response = await fetch(`/update_round_timer/${roundId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
            body: JSON.stringify({ duration: duration }),
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to update time');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred');
    }
}

async function finalizeRound(roundId) {
    if (!confirm('Are you sure you want to finalize this round? This cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/finalize_round/${roundId}`, {
            method: 'POST',
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to finalize round');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred');
    }
}

// Initialize timers for all active rounds
function initializeTimers() {
    {% for round in active_rounds %}
    initTimer({{ round.id }});
    {% endfor %}
}

async function initTimer(roundId) {
    try {
        const checkStatus = async () => {
            const response = await fetch(`/check_round_status/${roundId}`);
            const data = await response.json();
            
            if (!data.active) {
                // Round is no longer active, reload the page
                location.reload();
        return;
    }
    
            // Update the timer display
            const remainingSeconds = Math.floor(data.remaining);
            const minutes = Math.floor(remainingSeconds / 60);
            const seconds = remainingSeconds % 60;
            const timerElement = document.getElementById(`timer-remaining-${roundId}`);
            
            if (timerElement) {
                timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Set color based on remaining time
                if (remainingSeconds < 30) {
                    timerElement.className = 'px-3 py-1.5 rounded-xl bg-red-100/80 text-red-600 font-bold backdrop-blur-sm';
                } else if (remainingSeconds < 60) {
                    timerElement.className = 'px-3 py-1.5 rounded-xl bg-orange-100/80 text-orange-500 font-bold backdrop-blur-sm';
                    } else {
                    timerElement.className = 'px-3 py-1.5 rounded-xl bg-green-100/80 text-green-600 backdrop-blur-sm';
                }
            }
            
            // Check again in 1 second
            setTimeout(checkStatus, 1000);
        };
        
        // Start checking
        checkStatus();
    } catch (error) {
        console.error('Error initializing timer:', error);
    }
}

// Initialize timers when the page loads
document.addEventListener('DOMContentLoaded', initializeTimers);

async function deleteRound(roundId) {
    if (!confirm('Are you sure you want to delete this round? This will release all players allocated in this round and refund the acquisition values to their teams. This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/admin/delete_round/${roundId}`, {
            method: 'POST',
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert(`Round deleted successfully. ${data.released_players} players have been released.\n${data.refunded_amount.toLocaleString()} credits refunded to teams.`);
            location.reload();
        } else {
            alert(data.error || 'Failed to delete round');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while deleting the round');
    }
}
</script>
{% endblock %}