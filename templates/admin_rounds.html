{% extends "base.html" %}

{% block title %}Manage Rounds - Auction System{% endblock %}

{% block content %}
<!-- Loading Overlay -->
<div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-50 flex items-center justify-center transition-opacity duration-300 opacity-0 pointer-events-none">
    <div class="flex flex-col items-center bg-white/90 p-6 rounded-2xl shadow-lg max-w-sm mx-auto text-center">
        <div class="w-16 h-16 border-4 border-primary/30 border-t-primary rounded-full animate-spin mb-4"></div>
        <p class="text-gray-700 font-medium" id="loading-message">Processing your request...</p>
        <p class="text-xs text-gray-500 mt-2">This may take a moment</p>
    </div>
</div>

<div class="container mx-auto px-3 sm:px-4 py-4 sm:py-6 max-w-7xl">
    <div class="glass rounded-3xl p-4 sm:p-6 mb-4 backdrop-blur-md border border-white/20 shadow-xl">
        <div class="flex flex-col gap-4 mb-6">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                <div class="flex items-center">
                    <a href="{{ url_for('dashboard') }}" class="inline-flex items-center justify-center p-2 mr-3 rounded-xl bg-white/60 text-gray-700 hover:bg-white/80 transition-all duration-200 backdrop-blur-sm border border-gray-200/50 shadow-sm">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                    </a>
                    <div>
                        <h2 class="text-2xl font-bold text-dark gradient-text">Round Management</h2>
                        <p class="text-sm text-gray-600 mt-1">Create and manage auction rounds</p>
                    </div>
                </div>
                
                <div class="flex items-center">
                    <span class="inline-flex items-center px-3 py-1.5 rounded-full bg-blue-100 text-blue-800 text-sm font-medium">
                        <span class="flex-shrink-0 w-2 h-2 rounded-full bg-blue-500 mr-1.5"></span>
                        <span>{{ rounds|selectattr('is_active', 'eq', true)|list|length }} Active</span>
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Create New Round Section -->
        <div class="glass rounded-2xl p-4 sm:p-6 mb-6 border border-white/20 transform transition-all duration-300 hover:shadow-lg backdrop-blur-sm">
            <h2 class="text-lg sm:text-xl font-bold mb-4 gradient-text flex items-center">
                <svg class="w-5 h-5 mr-2 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
                Start New Round
            </h2>
            <form id="startRoundForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="position" class="block text-sm font-medium text-gray-700 mb-1.5">Position</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-gray-400">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z" />
                                </svg>
                            </span>
                            <select id="position" name="position" required
                                class="pl-10 w-full py-3 bg-white/60 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all duration-200 text-base shadow-sm">
                                <option value="">Select a position</option>
                                {% for position in config.POSITIONS %}
                                <option value="{{ position }}">{{ position }}</option>
                                {% endfor %}
                                
                                <!-- Position Groups -->
                                {% for position_group in config.POSITION_GROUPS %}
                                <option value="{{ position_group }}">{{ position_group }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="duration" class="block text-sm font-medium text-gray-700 mb-1.5">Duration (seconds)</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-gray-400">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </span>
                            <input type="number" id="duration" name="duration" value="300" min="30" required
                                class="pl-10 w-full py-3 bg-white/60 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all duration-200 text-base shadow-sm">
                        </div>
                        <p class="mt-1 text-xs text-gray-500">Recommended: 5-10 minutes (300-600 seconds)</p>
                    </div>
                    <div>
                        <label for="max_bids_per_team" class="block text-sm font-medium text-gray-700 mb-1.5">Required Bids Per Team</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-gray-400">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                            </span>
                            <input type="number" id="max_bids_per_team" name="max_bids_per_team" value="5" min="1" required
                                class="pl-10 w-full py-3 bg-white/60 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all duration-200 text-base shadow-sm">
                        </div>
                        <p class="mt-1 text-xs text-gray-500">Teams must bid exactly this many players for their bids to be considered</p>
                    </div>
                </div>
                
                <div class="flex justify-end mt-2">
                    <button type="submit"
                        id="start-round-button"
                        class="px-6 py-3 rounded-xl bg-gradient-to-r from-primary to-secondary text-white font-medium hover:from-primary/90 hover:to-secondary/90 transform hover:scale-[1.01] active:scale-[0.99] transition-all duration-200 shadow-md flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                        Start Round
                    </button>
                </div>
            </form>
        </div>

        <!-- Active Rounds Section -->
        <div class="glass rounded-2xl p-4 sm:p-6 mb-6 border border-white/20 backdrop-blur-sm">
            <h2 class="text-lg sm:text-xl font-bold mb-4 gradient-text flex items-center">
                <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                Active Rounds
                {% if active_rounds %}
                <span class="ml-2 px-2.5 py-0.5 rounded-full bg-green-100 text-green-800 text-xs font-medium">
                    {{ active_rounds|length }}
                </span>
                {% endif %}
            </h2>
            <div id="activeRounds" class="space-y-4">
                {% for round in active_rounds %}
                <div class="glass rounded-xl p-4 sm:p-5 border border-green-200/30 hover:shadow-lg transition-all duration-300 backdrop-blur-sm relative overflow-hidden" data-round-id="{{ round.id }}">
                    <div class="absolute top-0 right-0 bg-green-500 text-white px-3 py-1 text-xs font-medium rounded-bl-lg">
                        Active
                    </div>
                    
                    <div class="flex flex-col gap-4">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center flex-shrink-0 mr-3">
                                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z" />
                                    </svg>
                                </div>
                                <h3 class="text-base sm:text-lg font-semibold">{{ round.position }} Round #{{ round.id }}</h3>
                            </div>
                            <div class="text-sm font-medium px-4 py-2 rounded-xl bg-white/80 backdrop-blur-sm shadow-sm flex items-center" id="timer-{{ round.id }}">
                                <svg class="w-4 h-4 mr-2 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span id="timer-remaining-{{ round.id }}" class="font-mono">--:--</span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div class="glass rounded-xl p-3 backdrop-blur-sm flex items-center gap-4">
                                <div class="relative flex-1 max-w-[120px]">
                                    <input type="number" id="update-duration-{{ round.id }}" min="30" value="60"
                                        class="w-full py-2.5 px-3 rounded-xl bg-white border border-gray-200 focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none text-base shadow-sm">
                                    <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-xs text-gray-500">sec</span>
                                </div>
                                <button onclick="updateRoundTimer({{ round.id }})"
                                    class="bg-primary/90 text-white px-4 py-2.5 rounded-xl hover:bg-primary transition-all duration-200 text-sm whitespace-nowrap flex items-center justify-center">
                                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                    </svg>
                                    Add Time
                                </button>
                            </div>
                            
                            <button onclick="finalizeRound({{ round.id }})"
                                class="bg-green-500 text-white px-4 py-3 rounded-xl hover:bg-green-600 transition-all duration-200 font-medium flex items-center justify-center">
                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                                Finalize Round
                            </button>
                        </div>
                    </div>

                    {% if round.status == "processing" %}
                    <div class="mt-4 glass rounded-xl border-l-4 border-yellow-400 p-4 backdrop-blur-sm bg-yellow-50/70">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-yellow-700">
                                    <strong>Round in processing.</strong> Resolve all tiebreakers before finalizing this round.
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <div class="text-center py-8 glass rounded-xl border border-gray-100/20 bg-white/5">
                    <svg class="w-12 h-12 mx-auto text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <h3 class="mt-2 text-lg font-medium text-gray-500">No active rounds</h3>
                    <p class="mt-1 text-gray-500">Start a new round using the form above</p>
                    <button onclick="document.getElementById('start-round-button').scrollIntoView({ behavior: 'smooth' })"
                        class="mt-4 px-6 py-2.5 bg-primary/90 text-white rounded-xl hover:bg-primary text-sm transition-all duration-200 shadow-sm">
                        <svg class="w-4 h-4 inline mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                        Start Round
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Active Tiebreakers Section (if any) -->
        {% if active_tiebreakers %}
        <div class="glass rounded-2xl p-4 sm:p-6 mb-6 border border-white/20 backdrop-blur-sm">
            <h2 class="text-lg sm:text-xl font-bold mb-4 gradient-text flex items-center">
                <svg class="w-5 h-5 mr-2 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                Active Tiebreakers
                <span class="ml-2 px-2.5 py-0.5 rounded-full bg-yellow-100 text-yellow-800 text-xs font-medium">
                    {{ active_tiebreakers|length }}
                </span>
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {% for tiebreaker in active_tiebreakers %}
                <div class="glass rounded-xl p-4 backdrop-blur-sm hover:shadow-md transition-all duration-200 border border-yellow-100/30">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-3">
                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center flex-shrink-0">
                                <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zm-4 7a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                            </div>
                            <div>
                                <h4 class="font-medium text-dark">{{ tiebreaker.player.name }}</h4>
                                <div class="flex items-center text-sm text-gray-500 mt-1">
                                    <span class="inline-block w-2.5 h-2.5 rounded-full mr-1.5 {{ {'GK': 'bg-yellow-400', 'DEF': 'bg-blue-400', 'MID': 'bg-green-400', 'FWD': 'bg-red-400'}.get(tiebreaker.player.position, 'bg-gray-400') }}"></span>
                                    {{ tiebreaker.player.position }} • Bid: <span class="font-semibold text-primary">£{{ tiebreaker.original_amount }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <span class="px-3 py-1.5 rounded-full bg-yellow-100 text-yellow-800 text-xs font-medium flex items-center">
                                <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                                {{ tiebreaker.team_tiebreakers|length }} teams
                            </span>
                            <a href="{{ url_for('get_tiebreaker', tiebreaker_id=tiebreaker.id) }}" 
                               class="px-3 py-1.5 rounded-full bg-white/60 text-primary hover:bg-white text-xs font-medium transition-colors flex items-center shadow-sm">
                                <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                                View Details
                            </a>
                        </div>
                    </div>
                    
                    <div class="glass rounded-xl p-3 backdrop-blur-sm mt-3">
                        <h4 class="font-medium mb-2 text-sm text-gray-700">Bid Status</h4>
                        <p class="mb-2 text-sm">
                            {% set submitted = tiebreaker.team_tiebreakers|selectattr('new_amount', 'defined')|list|length %}
                            {% set total = tiebreaker.team_tiebreakers|length %}
                            <span class="px-3 py-1.5 inline-flex text-xs leading-5 font-semibold rounded-full {% if submitted == total %}bg-green-100 text-green-800{% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                {{ submitted }} of {{ total }} teams submitted
                            </span>
                        </p>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-primary h-2.5 rounded-full" style="width: {{ (submitted / total * 100)|round }}%"></div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Round Results Section -->
        <div class="glass rounded-2xl p-4 sm:p-6 border border-white/20 backdrop-blur-sm">
            <h2 class="text-lg sm:text-xl font-bold mb-4 gradient-text flex items-center">
                <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                Completed Rounds
                {% if rounds|selectattr('is_active', 'eq', false)|list %}
                <span class="ml-2 px-2.5 py-0.5 rounded-full bg-blue-100 text-blue-800 text-xs font-medium">
                    {{ rounds|selectattr('is_active', 'eq', false)|list|length }}
                </span>
                {% endif %}
            </h2>
            
            <div class="space-y-4">
                {% for round in rounds|sort(attribute='id', reverse=true) %}
                {% if not round.is_active %}
                <div class="glass rounded-xl p-4 sm:p-5 border border-blue-100/30 transform transition-all duration-300 hover:shadow-lg backdrop-blur-sm">
                    <div class="flex flex-col gap-4">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0 mr-3">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z" />
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-base sm:text-lg font-semibold">{{ round.position }} Round #{{ round.id }}</h3>
                                    <p class="text-xs text-gray-500 mt-1">{{ round.start_time.strftime('%Y-%m-%d %H:%M') }}</p>
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                <span class="text-xs text-blue-600 bg-blue-50 px-3 py-1.5 rounded-lg flex items-center">
                                    <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                    </svg>
                                    {{ round.players|selectattr('team_id')|list|length }} players allocated
                                </span>
                                <span class="text-xs text-primary bg-primary/10 px-3 py-1.5 rounded-lg flex items-center">
                                    <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    {{ round.status|capitalize }}
                                </span>
                            </div>
                        </div>
                        
                        <!-- Player allocations preview -->
                        <div class="bg-white/30 p-3 rounded-xl backdrop-blur-sm">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-medium text-gray-700 flex items-center">
                                    <svg class="w-4 h-4 mr-1.5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                    </svg>
                                    Player Allocations
                                </h4>
                                <span class="text-xs text-gray-500">Showing first 5</span>
                            </div>
                            
                            <div class="space-y-2">
                                {% set allocated_players = round.players|selectattr('team_id')|list %}
                                {% if allocated_players %}
                                    {% for player in allocated_players[:5] %}
                                    <div class="glass rounded-lg p-2.5 backdrop-blur-sm border border-gray-100/30 hover:shadow-sm transition-all duration-200">
                                        <div class="flex justify-between items-center">
                                            <div class="flex items-center gap-2 mr-2">
                                                <div class="w-8 h-8 rounded-full bg-{{ {'GK': 'yellow', 'DEF': 'blue', 'MID': 'green', 'FWD': 'red'}.get(player.position, 'gray') }}-100 flex items-center justify-center text-{{ {'GK': 'yellow', 'DEF': 'blue', 'MID': 'green', 'FWD': 'red'}.get(player.position, 'gray') }}-500 text-xs font-bold">
                                                    {{ player.position[0] }}
                                                </div>
                                                <div class="truncate">
                                                    <div class="text-sm font-medium">{{ player.name }}</div>
                                                    <div class="text-xs text-gray-500">{{ player.position }}</div>
                                                </div>
                                            </div>
                                            <div class="flex flex-col items-end text-right">
                                                <div class="text-xs px-2 py-0.5 bg-primary/10 rounded-lg text-primary">{{ player.team.name }}</div>
                                                <div class="text-sm font-bold mt-1 text-gray-800">
                                                    {% for bid in player.bids %}
                                                        {% if bid.team_id == player.team_id %}
                                                            £{{ "{:,}".format(bid.amount) }}
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                    
                                    {% if allocated_players|length > 5 %}
                                    <div class="text-center py-2">
                                        <a href="{{ url_for('admin_round_detail', round_id=round.id) }}" class="text-primary text-sm inline-flex items-center hover:underline">
                                            <span>See all {{ allocated_players|length }} allocations</span>
                                            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                                            </svg>
                                        </a>
                                    </div>
                                    {% endif %}
                                {% else %}
                                    <div class="text-center py-4 glass rounded-lg bg-white/30 text-sm text-gray-500 italic">
                                        No players were allocated in this round
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap justify-end gap-2 mt-1">
                            <a href="{{ url_for('admin_round_detail', round_id=round.id) }}" 
                               class="inline-flex items-center px-4 py-2.5 rounded-xl bg-primary/10 text-primary hover:bg-primary/20 transition-colors text-sm shadow-sm">
                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                                View Details
                            </a>
                            <button onclick="deleteRound({{ round.id }})" 
                                class="inline-flex items-center px-4 py-2.5 rounded-xl bg-red-500/10 text-red-500 hover:bg-red-500/20 transition-colors text-sm shadow-sm">
                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% else %}
                <div class="text-center py-8 glass rounded-xl bg-white/10 backdrop-blur-sm border border-gray-100/20">
                    <svg class="w-12 h-12 mx-auto text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                    </svg>
                    <h3 class="mt-2 text-lg font-medium text-gray-500">No completed rounds yet</h3>
                    <p class="mt-1 text-gray-500">Past rounds will appear here once they're finalized</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
// Show toast notification
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    const successIcon = document.getElementById('toast-icon-success');
    const errorIcon = document.getElementById('toast-icon-error');
    
    document.getElementById('toast-message').textContent = message;
    
    // Show the appropriate icon
    if (type === 'success') {
        successIcon.classList.remove('hidden');
        errorIcon.classList.add('hidden');
        toast.classList.remove('bg-red-50');
        toast.classList.add('bg-white');
    } else {
        successIcon.classList.add('hidden');
        errorIcon.classList.remove('hidden');
        toast.classList.add('bg-red-50');
        toast.classList.remove('bg-white');
    }
    
    // Show toast
    toast.classList.remove('translate-y-20', 'opacity-0');
    
    // Hide toast after 3 seconds
    setTimeout(() => {
        toast.classList.add('translate-y-20', 'opacity-0');
    }, 3000);
}

// Show loading overlay with custom message
function showLoading(message = 'Processing your request...') {
    const overlay = document.getElementById('loading-overlay');
    const messageEl = document.getElementById('loading-message');
    
    if (messageEl) {
        messageEl.textContent = message;
    }
    
    if (overlay) {
        // Force any existing transitions to complete
        overlay.classList.remove('transition-opacity');
        void overlay.offsetWidth; // Trigger reflow
        overlay.classList.add('transition-opacity');
        
        // Show the overlay
        overlay.classList.remove('opacity-0', 'pointer-events-none');
        
        // Ensure any previous hide operations are cancelled
        if (overlay.hideTimeout) {
            clearTimeout(overlay.hideTimeout);
            delete overlay.hideTimeout;
        }
    }
}

// Hide loading overlay
function hideLoading() {
    const overlay = document.getElementById('loading-overlay');
    
    if (overlay) {
        // Add a small delay to ensure it's visible long enough for the user to see it
        overlay.hideTimeout = setTimeout(() => {
            overlay.classList.add('opacity-0', 'pointer-events-none');
        }, 300);
    }
}

// Global variables for auto-refresh
let autoRefreshEnabled = true;
let refreshInterval = 10000; // 10 seconds by default
let lastRefreshTimestamp = Date.now();
let refreshTimer = null;
let isUpdating = false;

// Auto-refresh indicator element
const createRefreshIndicator = () => {
    const indicator = document.createElement('div');
    indicator.id = 'refresh-indicator';
    indicator.className = 'fixed bottom-4 right-4 bg-white/80 backdrop-blur-sm shadow-lg rounded-full px-3 py-2 text-xs font-medium text-gray-700 flex items-center gap-2 z-10 opacity-0 transition-opacity duration-300';
    
    const refreshIcon = document.createElement('div');
    refreshIcon.className = 'w-3 h-3 rounded-full bg-primary animate-pulse';
    
    const text = document.createElement('span');
    text.textContent = 'Refreshing...';
    
    const toggleButton = document.createElement('button');
    toggleButton.className = 'ml-2 px-2 py-0.5 rounded bg-gray-100 hover:bg-gray-200 transition-colors text-gray-600 text-xs';
    toggleButton.textContent = 'Disable';
    toggleButton.onclick = toggleAutoRefresh;
    
    indicator.appendChild(refreshIcon);
    indicator.appendChild(text);
    indicator.appendChild(toggleButton);
    
    document.body.appendChild(indicator);
};

// Toggle auto-refresh functionality
function toggleAutoRefresh() {
    autoRefreshEnabled = !autoRefreshEnabled;
    const toggleButton = document.querySelector('#refresh-indicator button');
    
    if (toggleButton) {
        toggleButton.textContent = autoRefreshEnabled ? 'Disable' : 'Enable';
    }
    
    if (autoRefreshEnabled) {
        startAutoRefresh();
        showToast('Auto-refresh enabled', 'success');
    } else {
        clearTimeout(refreshTimer);
        showToast('Auto-refresh disabled', 'success');
    }
}

// Show refresh indicator
function showRefreshIndicator() {
    const indicator = document.getElementById('refresh-indicator');
    if (indicator) {
        indicator.classList.remove('opacity-0');
    }
}

// Hide refresh indicator
function hideRefreshIndicator() {
    const indicator = document.getElementById('refresh-indicator');
    if (indicator) {
        indicator.classList.add('opacity-0');
    }
}

// Start Round Form Submission
document.getElementById('startRoundForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const position = document.getElementById('position').value;
    const duration = document.getElementById('duration').value;
    const max_bids_per_team = document.getElementById('max_bids_per_team').value;
    
    showLoading('Starting new round...');
    
    try {
        const response = await fetch('/start_round', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ position, duration, max_bids_per_team }),
        });
        
        if (response.ok) {
            const data = await response.json();
            showToast(`Round for ${position} started successfully`, 'success');
            
            // Instead of reloading, fetch updated content
            await fetchUpdates(true);
            
            // After content update, directly set the timer value and initialize timer immediately
            if (data.round_id) {
                // Wait a bit to ensure DOM is updated
                setTimeout(() => {
                    // Force immediate timer initialization for the new round
                    const roundId = data.round_id;
                    initTimer(roundId);
                }, 100);
            }
            
            hideLoading(); // Ensure loading is hidden after fetch completes
        } else {
            const data = await response.json();
            hideLoading();
            showToast(data.error || 'Failed to start round', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        hideLoading();
        showToast('An error occurred while starting the round', 'error');
    }
});

// Update Round Timer
async function updateRoundTimer(roundId) {
    const duration = document.getElementById(`update-duration-${roundId}`).value;
    
    if (parseInt(duration) < 30) {
        showToast('Duration must be at least 30 seconds', 'error');
        return;
    }
    
    showLoading('Updating timer...');
    
    try {
        const response = await fetch(`/update_round_timer/${roundId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ duration: duration }),
        });
        
        if (response.ok) {
            const data = await response.json();
            hideLoading();
            showToast(`Added ${duration} seconds to the timer`, 'success');
            // Fetch updates to refresh timer display
            await fetchUpdates();
        } else {
            const data = await response.json();
            hideLoading();
            showToast(data.error || 'Failed to update timer', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        hideLoading();
        showToast('An error occurred while updating the timer', 'error');
    }
}

// Force page refresh with exponential backoff retry
async function forcePageRefresh(maxRetries = 3, initialDelay = 500) {
    let retries = 0;
    let delay = initialDelay;
    
    const attemptRefresh = async () => {
        try {
            showLoading('Refreshing page data...');
            
            // Fetch data with cache busting
            const timestamp = Date.now();
            const response = await fetch(`/admin/rounds_update?_=${timestamp}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                },
                cache: 'no-store'
            });
            
            if (response.ok) {
                const data = await response.json();
                
                // Log refresh for debugging
                console.log('Forced page refresh successful');
                
                // Update all page sections
                updatePageContent(data);
                hideLoading();
                return true;
            } else {
                throw new Error('Failed to refresh page data');
            }
        } catch (error) {
            console.error('Error refreshing page:', error);
            if (retries < maxRetries) {
                retries++;
                delay *= 2; // Exponential backoff
                console.log(`Retry ${retries}/${maxRetries} in ${delay}ms`);
                await new Promise(resolve => setTimeout(resolve, delay));
                return attemptRefresh();
            } else {
                hideLoading();
                showToast('Failed to refresh page. Please refresh manually.', 'error');
                return false;
            }
        }
    };
    
    return attemptRefresh();
}

// Finalize Round
async function finalizeRound(roundId) {
    if (!confirm('Are you sure you want to finalize this round? This cannot be undone.')) {
        return;
    }
    
    showLoading('Finalizing round...');
    
    try {
        const response = await fetch(`/finalize_round/${roundId}`, {
            method: 'POST',
        });
        
        if (response.redirected) {
            window.location.href = response.url;
            return;
        }
        
        const data = await response.json();
        
        if (response.ok) {
            showToast('Round finalized successfully', 'success');
            
            // Force a complete page refresh with retries
            await forcePageRefresh();
        } else {
            hideLoading();
            showToast(data.error || 'Failed to finalize round', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        hideLoading();
        showToast('An error occurred while finalizing the round', 'error');
    }
}

// Delete Round
async function deleteRound(roundId) {
    if (!confirm('Are you sure you want to delete this round? This will release all players allocated in this round and refund the acquisition values to their teams. This action cannot be undone.')) {
        return;
    }
    
    showLoading('Deleting round and updating players...');
    
    try {
        const response = await fetch(`/admin/delete_round/${roundId}`, {
            method: 'POST',
        });
        
        const data = await response.json();
        
        if (response.ok) {
            hideLoading();
            let message = 'Round deleted successfully';
            
            if (data.released_players > 0) {
                message += `. ${data.released_players} player${data.released_players !== 1 ? 's' : ''} released`;
                
                if (data.refunded_amount > 0) {
                    message += `, £${data.refunded_amount.toLocaleString()} refunded to teams`;
                }
            }
            
            showToast(message, 'success');
            
            // Force a complete page refresh with retries
            await forcePageRefresh();
        } else {
            hideLoading();
            showToast(data.error || 'Failed to delete round', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        hideLoading();
        showToast('An error occurred while deleting the round', 'error');
    }
}

// Format time display (XX:XX format)
function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

// Initialize timers for all active rounds
function initializeTimers() {
    {% for round in active_rounds %}
    initTimer({{ round.id }});
    {% endfor %}
}

// Initialize timer for a specific round
async function initTimer(roundId) {
    try {
        // Immediately show a placeholder while we fetch the initial time
        const timerElement = document.getElementById(`timer-remaining-${roundId}`);
        if (timerElement) {
            timerElement.textContent = "Loading...";
        }
        
        // Fetch initial time from server right away
        const initialResponse = await fetch(`/check_round_status/${roundId}`);
        const initialData = await initialResponse.json();
        
        // Update timer with initial value immediately
        if (timerElement && initialData.active) {
            timerElement.textContent = formatTime(initialData.remaining);
            
            // Set visual indicators based on remaining time
            const timerContainer = document.getElementById(`timer-${roundId}`);
            if (timerContainer) {
                if (initialData.remaining < 30) {
                    timerContainer.className = 'text-sm font-medium px-4 py-2 rounded-xl bg-red-50 text-red-600 backdrop-blur-sm shadow-sm flex items-center animate-pulse';
                } else if (initialData.remaining < 60) {
                    timerContainer.className = 'text-sm font-medium px-4 py-2 rounded-xl bg-orange-50 text-orange-600 backdrop-blur-sm shadow-sm flex items-center';
                } else {
                    timerContainer.className = 'text-sm font-medium px-4 py-2 rounded-xl bg-white/80 backdrop-blur-sm shadow-sm flex items-center';
                }
            }
        }
        
        const checkStatus = async () => {
            try {
                const response = await fetch(`/check_round_status/${roundId}`);
                const data = await response.json();
                
                if (!data.active) {
                    // Round is no longer active, update content instead of full reload
                    await fetchUpdates(true);
                    hideLoading(); // Ensure loading is hidden
                    return;
                }
                
                // Update the timer display
                const remainingSeconds = Math.floor(data.remaining);
                const timerElement = document.getElementById(`timer-remaining-${roundId}`);
                
                if (timerElement) {
                    timerElement.textContent = formatTime(remainingSeconds);
                    
                    // Set visual indicators based on remaining time
                    const timerContainer = document.getElementById(`timer-${roundId}`);
                    if (timerContainer) {
                        if (remainingSeconds < 30) {
                            timerContainer.className = 'text-sm font-medium px-4 py-2 rounded-xl bg-red-50 text-red-600 backdrop-blur-sm shadow-sm flex items-center animate-pulse';
                        } else if (remainingSeconds < 60) {
                            timerContainer.className = 'text-sm font-medium px-4 py-2 rounded-xl bg-orange-50 text-orange-600 backdrop-blur-sm shadow-sm flex items-center';
                        } else {
                            timerContainer.className = 'text-sm font-medium px-4 py-2 rounded-xl bg-white/80 backdrop-blur-sm shadow-sm flex items-center';
                        }
                    }
                }
                
                // Check again in 1 second
                setTimeout(checkStatus, 1000);
            } catch (error) {
                console.error('Error checking round status:', error);
                hideLoading(); // Ensure loading is hidden on error
                // Retry after a delay
                setTimeout(checkStatus, 5000);
            }
        };
        
        // Start checking immediately
        checkStatus();
    } catch (error) {
        console.error('Error initializing timer:', error);
        hideLoading(); // Ensure loading is hidden on error
    }
}

// Fetch updates from server
async function fetchUpdates(forceRefresh = false) {
    // Prevent multiple simultaneous update requests
    if (isUpdating && !forceRefresh) return;
    
    // Don't refresh too frequently unless forced
    const now = Date.now();
    if (!forceRefresh && now - lastRefreshTimestamp < 5000) return;
    
    isUpdating = true;
    lastRefreshTimestamp = now;
    showRefreshIndicator();
    
    try {
        // Use cache busting for forced refreshes
        const cacheBuster = forceRefresh ? `?_=${Date.now()}` : '';
        const headers = {
            'X-Requested-With': 'XMLHttpRequest'
        };
        
        // Add cache control headers for forced refreshes
        if (forceRefresh) {
            Object.assign(headers, {
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache',
                'Expires': '0'
            });
        }
        
        const response = await fetch(`/admin/rounds_update${cacheBuster}`, {
            method: 'GET',
            headers: headers,
            cache: forceRefresh ? 'no-store' : 'default'
        });
        
        if (response.ok) {
            const data = await response.json();
            
            // When force refreshing, ensure we get the latest data from server
            if (forceRefresh) {
                console.log("Force refreshing page content");
            }
            
            updatePageContent(data);
            hideLoading(); // Always hide loading overlay after updating content
        }
    } catch (error) {
        console.error('Error fetching updates:', error);
        hideLoading(); // Hide loading overlay even if there's an error
    } finally {
        isUpdating = false;
        hideRefreshIndicator();
        
        // Schedule next update if auto-refresh is enabled
        if (autoRefreshEnabled) {
            clearTimeout(refreshTimer);
            refreshTimer = setTimeout(() => fetchUpdates(), refreshInterval);
        }
    }
}

// Update page content with new data
function updatePageContent(data) {
    // Update active rounds count
    const activeRoundsCount = document.querySelector('.inline-flex.items-center.rounded-full.bg-blue-100 span:last-child');
    if (activeRoundsCount) {
        activeRoundsCount.textContent = `${data.active_count} Active`;
    }
    
    // Update active rounds section
    if (data.activeRoundsHtml !== undefined) {
        const activeRoundsContainer = document.getElementById('activeRounds');
        if (activeRoundsContainer) {
            // Save scroll position
            const scrollPos = window.pageYOffset;
            
            // Update content
            activeRoundsContainer.innerHTML = data.activeRoundsHtml;
            
            // Restore scroll position
            window.scrollTo(0, scrollPos);
            
            // Re-initialize timers immediately to make sure they start running
            document.querySelectorAll('[id^="timer-remaining-"]').forEach(timer => {
                if (timer.textContent === "--:--") {
                    timer.textContent = "Loading...";
                }
            });
            
            // Get all active round IDs and initialize their timers
            const activeRoundElements = document.querySelectorAll('[data-round-id]');
            activeRoundElements.forEach(el => {
                const roundId = el.getAttribute('data-round-id');
                if (roundId) {
                    // Initialize timer for this round
                    initTimer(parseInt(roundId));
                }
            });
        }
    }
    
    // Update tiebreakers section if it exists
    if (data.tiebreakersHtml !== undefined) {
        // Look for the tiebreakers section by finding its heading first
        const tiebreakersHeading = Array.from(document.querySelectorAll('h2')).find(
            h => h.textContent.trim().includes('Active Tiebreakers')
        );
        
        // If found, get its parent section
        const tiebreakerSection = tiebreakersHeading ? 
            tiebreakersHeading.closest('.glass.rounded-2xl') : null;
        
        // Find the completed rounds section for reference
        const completedRoundsHeading = Array.from(document.querySelectorAll('h2')).find(
            h => h.textContent.trim().includes('Completed Rounds')
        );
        const completedRoundsSection = completedRoundsHeading ? 
            completedRoundsHeading.closest('.glass.rounded-2xl') : null;
        
        if (data.tiebreakersHtml && tiebreakerSection) {
            // Update existing section
            tiebreakerSection.innerHTML = data.tiebreakersHtml;
        } else if (data.tiebreakersHtml && !tiebreakerSection && completedRoundsSection) {
            // Need to add the tiebreakers section before completed rounds
            const newTiebreakersSection = document.createElement('div');
            newTiebreakersSection.className = 'glass rounded-2xl p-4 sm:p-6 mb-6 border border-white/20 backdrop-blur-sm';
            newTiebreakersSection.innerHTML = data.tiebreakersHtml;
            completedRoundsSection.parentNode.insertBefore(newTiebreakersSection, completedRoundsSection);
        } else if (!data.tiebreakersHtml && tiebreakerSection) {
            // Remove the tiebreakers section if no active tiebreakers
            tiebreakerSection.remove();
        }
    }
    
    // Update completed rounds section
    if (data.completedRoundsHtml !== undefined) {
        // Find the completed rounds heading
        const completedRoundsHeading = Array.from(document.querySelectorAll('h2')).find(
            h => h.textContent.trim().includes('Completed Rounds')
        );
        
        // If found, get its parent section and find the space-y-4 container inside
        if (completedRoundsHeading) {
            const completedRoundsSection = completedRoundsHeading.closest('.glass.rounded-2xl');
            if (completedRoundsSection) {
                const completedRoundsContainer = completedRoundsSection.querySelector('.space-y-4');
                
                if (completedRoundsContainer) {
                    // Log the update for debugging
                    console.log('Updating completed rounds section');
                    
                    // Save scroll position
                    const scrollPos = window.pageYOffset;
                    
                    // Update content
                    completedRoundsContainer.innerHTML = data.completedRoundsHtml;
                    
                    // Restore scroll position
                    window.scrollTo(0, scrollPos);
                } else {
                    console.warn('Could not find space-y-4 container in completed rounds section');
                }
            } else {
                console.warn('Could not find completed rounds section');
            }
        } else {
            console.warn('Could not find completed rounds heading');
        }
    } else {
        console.warn('No completed rounds HTML in update data');
    }
}

// Start auto-refresh mechanism
function startAutoRefresh() {
    // Initial fetch
    fetchUpdates();
    
    // Schedule regular updates
    clearTimeout(refreshTimer);
    refreshTimer = setTimeout(() => fetchUpdates(), refreshInterval);
}

// Initialize timers and auto-refresh when the page loads
document.addEventListener('DOMContentLoaded', function() {
    // Make sure loading overlay is hidden on page load
    hideLoading();
    
    // Create refresh indicator element
    createRefreshIndicator();
    
    // Perform an initial forced refresh to ensure page is up-to-date
    forcePageRefresh().then(() => {
        // Then initialize timers for active rounds
        initializeTimers();
        
        // Start regular auto-refresh
        startAutoRefresh();
    });
    
    // Add responsive behavior for mobile
    const adjustForMobile = () => {
        const isMobile = window.innerWidth < 640;
        const actionButtons = document.querySelectorAll('.action-button');
        
        actionButtons.forEach(button => {
            if (isMobile) {
                button.classList.add('w-full', 'justify-center');
            } else {
                button.classList.remove('w-full', 'justify-center');
            }
        });
    };
    
    // Run on load and on resize
    adjustForMobile();
    window.addEventListener('resize', adjustForMobile);
    
    // Add keyboard shortcut to toggle auto-refresh (Alt+R)
    document.addEventListener('keydown', function(e) {
        if (e.altKey && e.key === 'r') {
            toggleAutoRefresh();
        }
    });
});
</script>

<!-- Toast notification component -->
<div id="toast" class="fixed bottom-5 right-5 bg-white shadow-lg rounded-xl p-4 flex items-start max-w-xs z-50 transform translate-y-20 opacity-0 transition-all duration-300">
    <div class="flex-shrink-0 mr-3">
        <svg id="toast-icon-success" class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <svg id="toast-icon-error" class="h-6 w-6 text-red-500 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
    </div>
    <div>
        <p id="toast-message" class="text-gray-800 font-medium"></p>
    </div>
</div>
{% endblock %}