{% extends "base.html" %}

{% block title %}Round Results{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
  <div class="glass rounded-3xl p-6 sm:p-8 max-w-5xl mx-auto">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h2 class="text-2xl font-bold text-dark">Round Results</h2>
        <p class="text-sm text-gray-500">Round #{{ round.id }} • Position: {{ round.position }} • Status: {{ round.status|capitalize }}</p>
      </div>
      <a href="{{ url_for('dashboard') }}" class="px-4 py-2 rounded-xl bg-primary text-white text-sm font-medium hover:bg-primary-dark">Back to Dashboard</a>
    </div>

    {% if winning_bids %}
    <div class="mb-8">
      <h3 class="text-lg font-semibold text-dark mb-3">Winning Bids</h3>
      <div class="overflow-x-auto bg-white/60 rounded-2xl shadow-sm">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50/70">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Player</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Team</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Amount</th>
            </tr>
          </thead>
          <tbody class="bg-white/50 divide-y divide-gray-200">
            {% for bid in winning_bids %}
            <tr>
              <td class="px-4 py-3">{{ bid.player.name }} ({{ bid.player.position }})</td>
              <td class="px-4 py-3">{{ bid.team.name }}</td>
              <td class="px-4 py-3 text-right">£{{ "{:,}".format(bid.amount) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% else %}
    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r-xl mb-6">
      <p class="text-sm text-yellow-800">No players were allocated in this round.</p>
    </div>
    {% endif %}

    {% if resolved_tiebreakers %}
    <div class="mb-8">
      <h3 class="text-lg font-semibold text-dark mb-3">Resolved Tiebreakers</h3>
      <div class="space-y-3">
        {% for tb in resolved_tiebreakers %}
        <div class="bg-green-50 border border-green-200 p-4 rounded-xl">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-green-800">
                <strong>{{ tb.player.name }}</strong> tiebreaker resolved. 
                {% set winner_bid = bids | selectattr('player_id', 'equalto', tb.player_id) | selectattr('player.team_id', 'ne', None) | first %}
                {% if winner_bid %}
                Won by <strong>{{ winner_bid.team.name }}</strong> for £{{ "{:,}".format(winner_bid.amount) }}.
                {% else %}
                Resolution completed.
                {% endif %}
              </p>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
    
    {% if unresolved_tiebreakers %}
    <div class="mb-8">
      <h3 class="text-lg font-semibold text-dark mb-3">Pending Tiebreakers</h3>
      <div class="space-y-3">
        {% for tb in unresolved_tiebreakers %}
        <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-xl">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-yellow-800"><strong>{{ tb.player.name }}</strong> has a pending tiebreaker at £{{ "{:,}".format(tb.original_amount) }}.</p>
            </div>
            <a href="/tiebreaker/{{ tb.id }}" class="px-3 py-1.5 rounded-lg bg-yellow-600 text-white text-xs font-medium hover:bg-yellow-700">Go to Tiebreaker</a>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <div class="text-center">
      <a href="{{ url_for('dashboard') }}" class="inline-flex items-center px-5 py-2 rounded-xl bg-gradient-to-r from-primary to-primary-dark text-white text-sm font-medium hover:from-primary-dark hover:to-primary">Return to Dashboard</a>
    </div>
  </div>
</div>
{% endblock %}
