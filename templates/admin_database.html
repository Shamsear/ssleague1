{% extends "base.html" %}

{% block title %}Database Management - Admin{% endblock %}

{% block content %}
<div class="container mx-auto px-2 sm:px-4 py-4 sm:py-8">
    <div class="glass rounded-3xl p-4 sm:p-6">
        <div class="flex items-center mb-6">
            <div class="mr-4 flex-shrink-0">
                <div class="h-12 w-12 flex items-center justify-center rounded-full bg-blue-50 border border-blue-200">
                    <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" />
                    </svg>
                </div>
            </div>
            <div>
                <h2 class="text-xl font-bold text-dark">Database Management</h2>
                <p class="text-sm text-gray-500">Manage player data and SQLite database</p>
            </div>
        </div>
        
        <!-- Database Status -->
        <div class="glass-card mb-6 p-4 rounded-xl bg-white/30">
            <h3 class="font-medium text-dark mb-3">Database Status</h3>
            <div class="flex flex-col gap-2">
                <div class="flex justify-between p-3 bg-white/50 rounded-lg">
                    <span class="text-gray-600">Current Player Count:</span>
                    <span class="font-medium">{{ player_count }}</span>
                </div>
                
                <div class="flex justify-between p-3 bg-white/50 rounded-lg">
                    <span class="text-gray-600">SQLite Database:</span>
                    <span class="font-medium">
                        {% if db_exists %}
                            <span class="text-green-600">Found at {{ db_path }}</span>
                        {% else %}
                            <span class="text-red-600">Not found</span>
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Upload Database -->
        <div class="glass-card mb-6 p-4 rounded-xl bg-white/30">
            <h3 class="font-medium text-dark mb-3">Upload SQLite Database</h3>
            <p class="text-sm text-gray-500 mb-4">
                If the SQLite database wasn't properly deployed, you can upload it manually here.
                The file should be named <code>efootball_real.db</code> and contain a <code>players_all</code> table.
            </p>
            
            <form id="uploadForm" class="mb-4">
                <div class="flex flex-col sm:flex-row gap-3">
                    <div class="flex-grow">
                        <input type="file" id="sqliteFile" accept=".db" class="block w-full text-sm text-gray-500
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-full file:border-0
                            file:text-sm file:font-semibold
                            file:bg-blue-50 file:text-blue-700
                            hover:file:bg-blue-100
                        "/>
                    </div>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        Upload Database
                    </button>
                </div>
                <div id="uploadStatus" class="mt-2 text-sm"></div>
            </form>
        </div>
        
        <!-- Import Players -->
        <div class="glass-card p-4 rounded-xl bg-white/30">
            <h3 class="font-medium text-dark mb-3">Import Players from SQLite</h3>
            <p class="text-sm text-gray-500 mb-4">
                This will import players from the SQLite database into the PostgreSQL database.
                Make sure the SQLite database is available (uploaded or deployed).
            </p>
            
            <div class="flex justify-between items-center">
                <div>
                    <button id="importBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                        Import Players
                    </button>
                </div>
                <div>
                    <a href="{{ url_for('all_players') }}" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors inline-flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                        View All Players
                    </a>
                </div>
            </div>
            <div id="importStatus" class="mt-4 text-sm"></div>
        </div>
    </div>
</div>

<script>
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const fileInput = document.getElementById('sqliteFile');
        const statusDiv = document.getElementById('uploadStatus');
        
        if (!fileInput.files.length) {
            statusDiv.innerHTML = '<span class="text-red-600">Please select a file to upload</span>';
            return;
        }
        
        const file = fileInput.files[0];
        if (!file.name.endsWith('.db')) {
            statusDiv.innerHTML = '<span class="text-red-600">File must be a SQLite database (.db)</span>';
            return;
        }
        
        const formData = new FormData();
        formData.append('sqlite_db', file);
        
        statusDiv.innerHTML = '<span class="text-blue-600">Uploading database...</span>';
        
        fetch('/admin/upload_sqlite', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                statusDiv.innerHTML = `<span class="text-red-600">${data.error}</span>`;
            } else {
                statusDiv.innerHTML = `<span class="text-green-600">${data.success}</span>`;
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }
        })
        .catch(error => {
            statusDiv.innerHTML = `<span class="text-red-600">Error: ${error.message}</span>`;
        });
    });
    
    document.getElementById('importBtn').addEventListener('click', function() {
        const statusDiv = document.getElementById('importStatus');
        statusDiv.innerHTML = '<span class="text-blue-600">Importing players from SQLite database...</span>';
        
        fetch('/admin/import_players', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                statusDiv.innerHTML = `<span class="text-red-600">${data.error}</span>`;
            } else {
                statusDiv.innerHTML = `<span class="text-green-600">${data.success}</span>`;
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }
        })
        .catch(error => {
            statusDiv.innerHTML = `<span class="text-red-600">Error: ${error.message}</span>`;
        });
    });
</script>
{% endblock %} 