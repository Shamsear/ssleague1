{% extends "base.html" %}

{% block title %}Bulk Bid Tiebreaker - Football Auction{% endblock %}

{% block content %}
<div class="container mx-auto px-2 sm:px-4 py-4 sm:py-8">
    <!-- Tiebreaker Card -->
    <div class="glass rounded-3xl p-3 sm:p-6">
        <div class="flex flex-col sm:flex-row items-start sm:items-center mb-5 sm:mb-6">
            <div class="mr-3 sm:mr-4 flex-shrink-0 mb-3 sm:mb-0">
                <div class="h-10 w-10 sm:h-12 sm:w-12 flex items-center justify-center rounded-full bg-yellow-50 border border-yellow-200">
                    <svg class="h-5 w-5 sm:h-6 sm:w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                </div>
            </div>
            <div>
                <h2 class="text-lg sm:text-xl font-bold text-dark">Tiebreaker in Progress</h2>
                <p class="text-sm text-gray-500">Multiple teams have bid on this player. Increase your bid to win.</p>
            </div>
        </div>
        
        <!-- Player Info Card -->
        <div class="glass-card mb-5 sm:mb-6 p-4 rounded-xl backdrop-blur-sm bg-gradient-to-br from-white/30 to-white/10">
            <div class="flex flex-col sm:flex-row items-center gap-3 sm:gap-4">
                <div class="flex-shrink-0 w-16 h-16 sm:w-20 sm:h-20 rounded-full flex items-center justify-center bg-primary/10 text-primary font-bold text-lg sm:text-xl">
                    {{ player.position }}
                </div>
                <div class="text-center sm:text-left">
                    <h3 class="text-base sm:text-lg font-bold text-dark">{{ player.name }}</h3>
                    <p class="text-sm text-gray-500">{{ player.team_name }} • {{ player.position }}</p>
                    
                    {% if player.overall_rating %}
                    <div class="flex items-center justify-center sm:justify-start mt-2">
                        <div class="w-6 h-6 flex items-center justify-center rounded-full {% if player.overall_rating >= 90 %}bg-green-500{% elif player.overall_rating >= 80 %}bg-blue-500{% elif player.overall_rating >= 70 %}bg-yellow-500{% else %}bg-gray-500{% endif %} text-white text-xs font-bold">
                            {{ player.overall_rating }}
                        </div>
                        <span class="text-xs ml-1">{{ player.playing_style or 'Standard' }}</span>
                    </div>
                    {% endif %}
                </div>
                <div class="w-full sm:flex-grow"></div>
                <div class="mt-3 sm:mt-0 text-center bg-white/30 rounded-lg px-4 py-3 sm:py-2 w-full sm:w-auto">
                    <div class="text-sm text-gray-500">Current Bid</div>
                    <div class="text-xl font-bold text-primary">£{{ tiebreaker.current_amount }}</div>
                </div>
            </div>
        </div>
        
        <!-- Competing Teams Section -->
        <div class="glass-card mb-5 sm:mb-6 p-4 rounded-xl bg-white/30">
            <h4 class="font-medium text-dark mb-3">Competing Teams</h4>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3">
                {% for active_team in active_teams %}
                <div class="p-3 rounded-lg {% if active_team.team_id == current_user.team.id %}bg-primary/10 border border-primary/20{% else %}bg-white/60{% endif %}">
                    <div class="font-medium text-dark">{{ active_team.team.name }}</div>
                    {% if active_team.last_bid %}
                    <div class="text-sm text-gray-500">Last bid: £{{ active_team.last_bid }} ({{ active_team.last_bid_time.strftime('%H:%M:%S') }})</div>
                    {% else %}
                    <div class="text-sm text-gray-500">Waiting to bid...</div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Bidding Actions -->
        <div class="glass-card p-4 rounded-xl bg-white/50">
            <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                <div class="w-full sm:w-auto text-center sm:text-left mb-3 sm:mb-0">
                    <h4 class="font-medium text-dark">Your Action</h4>
                    <p class="text-sm text-gray-500">You can raise the bid or withdraw from this tiebreaker</p>
                    <div class="mt-1 text-xs text-blue-600">Your current balance: £{{ current_user.team.balance }}</div>
                </div>
                
                <div class="flex flex-col sm:flex-row items-center gap-3 w-full sm:w-auto">
                    <div class="relative w-full sm:w-auto">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500">£</span>
                        <input type="number" id="bidAmount" min="{{ tiebreaker.current_amount + 1 }}" max="{{ current_user.team.balance }}" value="{{ tiebreaker.current_amount + 1 }}" class="w-full sm:w-auto pl-8 pr-3 py-3 sm:py-2 text-base sm:text-sm rounded-lg border border-gray-300 focus:ring-primary focus:border-primary" style="min-width: 120px;">
                    </div>
                    
                    <div class="flex flex-row gap-2 w-full sm:w-auto">
                        <button type="button" onclick="placeBid({{ tiebreaker.id }})" class="flex-1 sm:flex-none px-4 py-3 sm:py-2 rounded-lg bg-primary text-white hover:bg-primary/90 transition-colors duration-200 text-sm font-medium">
                            Place Bid
                        </button>
                        
                        <button type="button" onclick="withdrawFromTiebreaker({{ tiebreaker.id }})" class="flex-1 sm:flex-none px-4 py-3 sm:py-2 rounded-lg bg-red-500 text-white hover:bg-red-600 transition-colors duration-200 text-sm font-medium">
                            Withdraw
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Rules Section -->
        <div class="mt-5 sm:mt-6 glass-card p-4 rounded-xl bg-blue-50/30 border border-blue-100/20">
            <h4 class="font-medium text-blue-700 mb-2">Tiebreaker Rules</h4>
            <ul class="text-sm text-blue-600 space-y-1.5 list-disc pl-5">
                <li>This is an open auction with no time limit.</li>
                <li>You can continue bidding as long as you have sufficient balance.</li>
                <li>The player will be awarded to the last team remaining.</li>
                <li>You can withdraw from the tiebreaker at any time.</li>
                <li>Once you withdraw, you cannot rejoin this tiebreaker.</li>
                <li>The tiebreaker ends when only one team remains.</li>
            </ul>
        </div>
        
        <!-- Status Indicator -->
        <div class="mt-4 sm:mt-5 text-center">
            <div class="inline-flex items-center px-3 py-1.5 bg-yellow-100/70 text-yellow-800 rounded-full text-xs font-medium animate-pulse">
                <span class="mr-1.5 w-2 h-2 bg-yellow-500 rounded-full"></span>
                Waiting for other teams
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for Bidding -->
<script>
    function placeBid(tiebreakerId) {
        const amount = document.getElementById('bidAmount').value;
        
        if (!amount) {
            alert('Please enter a bid amount.');
            return;
        }
        
        fetch('/place_bulk_tiebreaker_bid', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                tiebreaker_id: tiebreakerId,
                amount: amount
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                window.location.reload();
            }
        })
        .catch(error => {
            console.error('Error placing bid:', error);
            alert('An error occurred while placing your bid. Please try again.');
        });
    }
    
    function withdrawFromTiebreaker(tiebreakerId) {
        if (confirm('Are you sure you want to withdraw from this tiebreaker? You will not be able to bid on this player again in this round.')) {
            fetch('/withdraw_from_bulk_tiebreaker', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    tiebreaker_id: tiebreakerId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    window.location.href = '{{ url_for("team_bulk_round") }}';
                }
            })
            .catch(error => {
                console.error('Error withdrawing from tiebreaker:', error);
                alert('An error occurred while processing your request. Please try again.');
            });
        }
    }
    
    // Check if tiebreaker is resolved
    function checkTiebreakerStatus() {
        // Check if the tiebreaker is resolved
        fetch('/check_bulk_tiebreaker_status/{{ tiebreaker.id }}')
        .then(response => response.json())
        .then(data => {
            if (data.resolved) {
                // If resolved and current team is the winner, show success message and redirect
                if (data.winner_team_id === {{ current_user.team.id }}) {
                    // If there's another tiebreaker, go there
                    if (data.next_tiebreaker_id) {
                        window.location.href = '/team_bulk_tiebreaker/' + data.next_tiebreaker_id;
                    } else {
                        // Otherwise go to dashboard with success message
                        window.location.href = '{{ url_for("dashboard") }}?player_won={{ tiebreaker.player.name }}';
                    }
                } else {
                    // If not the winner, check for next tiebreaker or go to bulk round
                    if (data.next_tiebreaker_id) {
                        window.location.href = '/team_bulk_tiebreaker/' + data.next_tiebreaker_id;
                    } else {
                        window.location.href = '{{ url_for("team_bulk_round") }}';
                    }
                }
            } else {
                // If not resolved, continue checking
                setTimeout(checkTiebreakerStatus, 10000);
            }
        })
        .catch(error => {
            console.error('Error checking tiebreaker status:', error);
            // Continue checking even if there's an error
            setTimeout(checkTiebreakerStatus, 10000);
        });
    }
    
    // Start checking tiebreaker status
    checkTiebreakerStatus();
</script>
{% endblock %} 