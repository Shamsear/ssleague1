{% extends "base.html" %}

{% block title %}Bulk Bid Tiebreaker - Football Auction{% endblock %}

{% block content %}
<div class="container mx-auto px-2 sm:px-4 py-4 sm:py-8">
    <!-- Tiebreaker Card -->
    <div class="glass rounded-3xl p-4 sm:p-6">
        <div class="flex items-center mb-6">
            <div class="mr-4 flex-shrink-0">
                <div class="h-12 w-12 flex items-center justify-center rounded-full bg-yellow-50 border border-yellow-200">
                    <svg class="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                </div>
            </div>
            <div>
                <h2 class="text-xl font-bold text-dark">Tiebreaker in Progress</h2>
                <p class="text-sm text-gray-500">Multiple teams have bid on this player. Increase your bid to win.</p>
            </div>
        </div>
        
        <!-- Player Info Card -->
        <div class="glass-card mb-6 p-4 rounded-xl backdrop-blur-sm bg-gradient-to-br from-white/30 to-white/10">
            <div class="flex flex-col sm:flex-row items-center gap-4">
                <div class="flex-shrink-0 w-20 h-20 rounded-full flex items-center justify-center bg-primary/10 text-primary font-bold text-xl">
                    {{ player.position }}
                </div>
                <div class="text-center sm:text-left">
                    <h3 class="text-lg font-bold text-dark">{{ player.name }}</h3>
                    <p class="text-sm text-gray-500">{{ player.team_name }} • {{ player.position }}</p>
                    
                    {% if player.overall_rating %}
                    <div class="flex items-center justify-center sm:justify-start mt-2">
                        <div class="w-6 h-6 flex items-center justify-center rounded-full {% if player.overall_rating >= 90 %}bg-green-500{% elif player.overall_rating >= 80 %}bg-blue-500{% elif player.overall_rating >= 70 %}bg-yellow-500{% else %}bg-gray-500{% endif %} text-white text-xs font-bold">
                            {{ player.overall_rating }}
                        </div>
                        <span class="text-xs ml-1">{{ player.playing_style or 'Standard' }}</span>
                    </div>
                    {% endif %}
                </div>
                <div class="flex-grow"></div>
                <div class="text-center bg-white/30 rounded-lg px-4 py-2">
                    <div class="text-sm text-gray-500">Current Bid</div>
                    <div class="text-xl font-bold text-primary">£{{ tiebreaker.current_amount }}</div>
                </div>
            </div>
        </div>
        
        <!-- Competing Teams Section -->
        <div class="glass-card mb-6 p-4 rounded-xl bg-white/30">
            <h4 class="font-medium text-dark mb-3">Competing Teams</h4>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                {% for active_team in active_teams %}
                <div class="p-3 rounded-lg {% if active_team.team_id == current_user.team.id %}bg-primary/10 border border-primary/20{% else %}bg-white/60{% endif %}">
                    <div class="font-medium text-dark">{{ active_team.team.name }}</div>
                    {% if active_team.last_bid %}
                    <div class="text-sm text-gray-500">Last bid: £{{ active_team.last_bid }} ({{ active_team.last_bid_time.strftime('%H:%M:%S') }})</div>
                    {% else %}
                    <div class="text-sm text-gray-500">Waiting to bid...</div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Bidding Actions -->
        <div class="glass-card p-4 rounded-xl bg-white/50">
            <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                <div>
                    <h4 class="font-medium text-dark">Your Action</h4>
                    <p class="text-sm text-gray-500">You can raise the bid or withdraw from this tiebreaker</p>
                    <div class="mt-1 text-xs text-blue-600">Your current balance: £{{ current_user.team.balance }}</div>
                </div>
                
                <div class="flex flex-col sm:flex-row items-center gap-3">
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500">£</span>
                        <input type="number" id="bidAmount" min="{{ tiebreaker.current_amount + 1 }}" max="{{ current_user.team.balance }}" value="{{ tiebreaker.current_amount + 1 }}" class="pl-8 pr-3 py-2 text-sm rounded-lg border border-gray-300 focus:ring-primary focus:border-primary" style="min-width: 120px;">
                    </div>
                    
                    <button onclick="placeBid({{ tiebreaker.id }})" class="px-4 py-2 rounded-lg bg-primary text-white hover:bg-primary/90 transition-colors duration-200">
                        Place Bid
                    </button>
                    
                    {% set has_highest_bid = false %}
                    {% set highest_bid = 0 %}
                    {% set highest_bidder = none %}
                    
                    {% for team in active_teams %}
                        {% if team.last_bid and team.last_bid > highest_bid %}
                            {% set highest_bid = team.last_bid %}
                            {% set highest_bidder = team %}
                        {% endif %}
                    {% endfor %}
                    
                    {% if highest_bidder and highest_bidder.team_id == current_user.team.id and highest_bid > 0 %}
                        {% set has_highest_bid = true %}
                    {% endif %}
                    
                    <button onclick="withdrawFromTiebreaker({{ tiebreaker.id }})" 
                            class="px-4 py-2 rounded-lg {% if has_highest_bid %}bg-gray-400 cursor-not-allowed{% else %}bg-red-500 hover:bg-red-600{% endif %} text-white transition-colors duration-200"
                            {% if has_highest_bid %}disabled{% endif %}>
                        Withdraw
                    </button>
                </div>
                
                {% if has_highest_bid %}
                <div class="mt-3 text-sm text-yellow-700 bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                    <svg class="inline-block w-4 h-4 mr-1 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    You cannot withdraw while you have the highest bid. Other teams must outbid you first.
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Rules Section -->
        <div class="mt-6 glass-card p-4 rounded-xl bg-blue-50/30 border border-blue-100/20">
            <h4 class="font-medium text-blue-700 mb-2">Tiebreaker Rules</h4>
            <ul class="text-sm text-blue-600 space-y-1 list-disc pl-5">
                <li>This is an open auction with no time limit.</li>
                <li>You can continue bidding as long as you have sufficient balance.</li>
                <li>The player will be awarded to the last team remaining.</li>
                <li>You can withdraw from the tiebreaker at any time.</li>
                <li>Once you withdraw, you cannot rejoin this tiebreaker.</li>
                <li>The tiebreaker ends when only one team remains.</li>
            </ul>
        </div>
    </div>
</div>

<!-- JavaScript for Bidding -->
<script>
    function placeBid(tiebreakerId) {
        const amount = document.getElementById('bidAmount').value;
        
        if (!amount) {
            alert('Please enter a bid amount.');
            return;
        }
        
        fetch('/place_bulk_tiebreaker_bid', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                tiebreaker_id: tiebreakerId,
                amount: amount
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                window.location.reload();
            }
        })
        .catch(error => {
            console.error('Error placing bid:', error);
            alert('An error occurred while placing your bid. Please try again.');
        });
    }
    
    function withdrawFromTiebreaker(tiebreakerId) {
        if (confirm('Are you sure you want to withdraw from this tiebreaker? You will not be able to bid on this player again in this round.')) {
            fetch('/withdraw_from_bulk_tiebreaker', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    tiebreaker_id: tiebreakerId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    window.location.href = '{{ url_for("team_bulk_round") }}';
                }
            })
            .catch(error => {
                console.error('Error withdrawing from tiebreaker:', error);
                alert('An error occurred while processing your request. Please try again.');
            });
        }
    }
    
    // Track current highest bid for update detection
    let currentHighestBid = {{ tiebreaker.current_amount }};
    let lastUpdateTime = Date.now();
    let lastSoundTime = Date.now() - 60000; // Start with long delay so first update doesn't play sound
    let notificationsEnabled = false; // Default to silent mode
    let updateInterval = 5000; // Default polling interval - 5 seconds
    
    // Add notification settings controls to the UI
    function addNotificationControls() {
        const actionsDiv = document.querySelector('.glass-card.p-4.rounded-xl.bg-white\\/50');
        
        // Check if controls already exist
        if (document.getElementById('notification-controls')) return;
        
        const controlsHTML = `
            <div id="notification-controls" class="mt-4 pt-3 border-t border-gray-200 flex flex-wrap gap-3 items-center justify-end">
                <div class="text-xs text-gray-500">Update settings:</div>
                <div class="flex items-center">
                    <label for="sound-toggle" class="mr-2 text-xs cursor-pointer">
                        <span class="relative inline-block w-8 h-4 rounded-full bg-gray-200 transition-colors duration-200 ease-in-out ${notificationsEnabled ? 'bg-green-400' : ''}">
                            <span class="absolute inset-y-0 left-0 w-4 h-4 rounded-full bg-white shadow transform transition-transform duration-200 ease-in-out ${notificationsEnabled ? 'translate-x-4' : ''}"></span>
                        </span>
                        <span class="ml-1">Sound</span>
                    </label>
                    <input id="sound-toggle" type="checkbox" class="hidden" ${notificationsEnabled ? 'checked' : ''}>
                </div>
                <div class="flex items-center">
                    <label for="update-frequency" class="text-xs mr-2">Refresh:</label>
                    <select id="update-frequency" class="text-xs bg-white/60 border border-gray-200 rounded p-1">
                        <option value="2000" ${updateInterval === 2000 ? 'selected' : ''}>Fast (2s)</option>
                        <option value="5000" ${updateInterval === 5000 ? 'selected' : ''}>Normal (5s)</option>
                        <option value="10000" ${updateInterval === 10000 ? 'selected' : ''}>Slow (10s)</option>
                    </select>
                </div>
            </div>
        `;
        
        actionsDiv.insertAdjacentHTML('beforeend', controlsHTML);
        
        // Add event listeners
        document.getElementById('sound-toggle').addEventListener('change', function() {
            notificationsEnabled = this.checked;
            
            // Update toggle appearance
            const toggleBg = this.previousElementSibling.querySelector('span');
            const toggleKnob = toggleBg.querySelector('span');
            
            if (notificationsEnabled) {
                toggleBg.classList.add('bg-green-400');
                toggleKnob.classList.add('translate-x-4');
            } else {
                toggleBg.classList.remove('bg-green-400');
                toggleKnob.classList.remove('translate-x-4');
            }
            
            // Play a test sound if enabled
            if (notificationsEnabled) {
                playUpdateSound(0.1); // Quiet test sound
            }
        });
        
        document.getElementById('update-frequency').addEventListener('change', function() {
            updateInterval = parseInt(this.value);
        });
    }
    
    // Function to play notification sound with configurable volume
    function playUpdateSound(volume = 0.15) {
        if (!notificationsEnabled) return;
        
        // Respect the cooldown period to avoid sound spam
        const now = Date.now();
        if (now - lastSoundTime < 8000) return; // Minimum 8 seconds between sounds
        
        lastSoundTime = now;
        
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBgNLqPv/xHQrCgY1h+P4zYQ9GQ0ghfL98pBLIw8Xd/n/+5RLHg8Wha4OBjuYqsWQNw0LCiAXBjOkzOegRQkIGycHYh1DtOXgoUoMDyQnDmsGJ7Dq8bJZExwqMA5uBE+k8fnFcCEhLywPcwVEncTa12YiLTAZHQUKlvDx0FwaMywHHBgLChkHZJHN78FEDxgUBRkRBwwOA1ea3fO3OwwREAsgEgUOBgRcs+3/vi4HCAcNKRQIGRIMaMXw/rkgAwIFCjAXDR8SC3LT/f2yEgAAAAcxGBEkFQ+E4f/7pQgAAAAGMBsdKBUTl+v92JkEAAABCS0gJCQSIqj/95gMAQECCCgkJScSKbX/+ZEFAAIBBiQpJicULcL//48AAAAABSEtJiURN9D//4sAAAAABh8yKCIQPOD//4MGAgIDCBk2KR8RQ+///38AAAAAB2RQWUpEdv///3gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA');
        audio.volume = volume;
        audio.play().catch(e => console.log('Audio play prevented by browser policy'));
    }
    
    // Function to refresh competing teams section and current bid
    function refreshCompetingTeams() {
        fetch('/check_bulk_tiebreaker_status/{{ tiebreaker.id }}?include_teams=true')
            .then(response => response.json())
            .then(data => {
                if (data.resolved) {
                    // Handle resolved case - already implemented in checkTiebreakerStatus
                    return;
                }
                
                // Check if there's a new highest bid
                if (data.current_amount !== currentHighestBid) {
                    // Update the current bid display
                    document.querySelector('.text-xl.font-bold.text-primary').textContent = `£${data.current_amount}`;
                    
                    // Update the bid input minimum and value
                    document.getElementById('bidAmount').min = data.current_amount + 1;
                    document.getElementById('bidAmount').value = data.current_amount + 1;
                    
                    // Visual feedback - only flash briefly for significant changes
                    if (data.current_amount - currentHighestBid > 100) {
                        const bidDisplay = document.querySelector('.text-center.bg-white\\/30.rounded-lg');
                        bidDisplay.classList.add('bg-yellow-100');
                        setTimeout(() => bidDisplay.classList.remove('bg-yellow-100'), 800);
                    }
                    
                    // Play notification sound with rate limiting
                    playUpdateSound();
                    
                    currentHighestBid = data.current_amount;
                    lastUpdateTime = Date.now();
                }
                
                // Update competing teams section if data available
                if (data.competing_teams) {
                    const teamsContainer = document.querySelector('.glass-card.mb-6.p-4.rounded-xl.bg-white\\/30 .grid');
                    
                    // Check if we need to rebuild the teams display
                    let needsRebuild = false;
                    
                    // Check if team count has changed
                    if (teamsContainer.children.length !== data.competing_teams.length) {
                        needsRebuild = true;
                    } else {
                        // Check if the bid status of any team has changed substantially
                        for (const team of data.competing_teams) {
                            const existingTeamEl = Array.from(teamsContainer.children).find(el => 
                                el.querySelector('.font-medium.text-dark').textContent === team.name
                            );
                            
                            if (!existingTeamEl) {
                                needsRebuild = true;
                                break;
                            }
                            
                            const hasBid = existingTeamEl.textContent.includes('Last bid');
                            if (!hasBid && team.last_bid) {
                                // New bid from a team that didn't have one before
                                needsRebuild = true;
                                break;
                            } else if (hasBid && !team.last_bid) {
                                // Team's bid was removed (unlikely but possible)
                                needsRebuild = true;
                                break;
                            } else if (hasBid && team.last_bid) {
                                // Check if the bid amount has changed significantly
                                const bidText = existingTeamEl.textContent.match(/£(\d+)/);
                                if (bidText && parseInt(bidText[1]) !== team.last_bid) {
                                    needsRebuild = true;
                                    break;
                                }
                            }
                        }
                    }
                    
                    // Rebuild the teams display if needed
                    if (needsRebuild) {
                        teamsContainer.innerHTML = '';
                        
                        data.competing_teams.forEach(team => {
                            const isCurrentUser = team.id === {{ current_user.team.id }};
                            const teamHtml = `
                                <div class="p-3 rounded-lg ${isCurrentUser ? 'bg-primary/10 border border-primary/20' : 'bg-white/60'}">
                                    <div class="font-medium text-dark">${team.name}</div>
                                    ${team.last_bid 
                                      ? `<div class="text-sm text-gray-500">Last bid: £${team.last_bid} (${team.last_bid_time})</div>` 
                                      : `<div class="text-sm text-gray-500">Waiting to bid...</div>`}
                                </div>
                            `;
                            teamsContainer.innerHTML += teamHtml;
                        });
                        
                        // Check if current user has highest bid and update UI accordingly
                        const currentUserTeam = data.competing_teams.find(t => t.id === {{ current_user.team.id }});
                        const hasHighestBid = currentUserTeam && currentUserTeam.last_bid === data.current_amount;
                        
                        const withdrawButton = document.querySelector('button[onclick^="withdrawFromTiebreaker"]');
                        const withdrawDisabledMessage = document.querySelector('.mt-3.text-sm.text-yellow-700');
                        
                        if (hasHighestBid) {
                            withdrawButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                            withdrawButton.classList.remove('bg-red-500', 'hover:bg-red-600');
                            withdrawButton.disabled = true;
                            
                            if (!withdrawDisabledMessage) {
                                const messageHtml = `
                                    <div class="mt-3 text-sm text-yellow-700 bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                                        <svg class="inline-block w-4 h-4 mr-1 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        You cannot withdraw while you have the highest bid. Other teams must outbid you first.
                                    </div>
                                `;
                                withdrawButton.parentNode.insertAdjacentHTML('afterend', messageHtml);
                            }
                        } else {
                            withdrawButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                            withdrawButton.classList.add('bg-red-500', 'hover:bg-red-600');
                            withdrawButton.disabled = false;
                            
                            if (withdrawDisabledMessage) {
                                withdrawDisabledMessage.remove();
                            }
                        }
                    }
                }
                
                // Continue checking for updates with the user-selected interval
                setTimeout(refreshCompetingTeams, updateInterval);
            })
            .catch(error => {
                console.error('Error refreshing competing teams:', error);
                // Continue checking even if there's an error, but back off a bit
                setTimeout(refreshCompetingTeams, updateInterval * 2);
            });
    }
    
    // Check if tiebreaker is resolved
    function checkTiebreakerStatus() {
        // Check if the tiebreaker is resolved
        fetch('/check_bulk_tiebreaker_status/{{ tiebreaker.id }}')
        .then(response => response.json())
        .then(data => {
            if (data.resolved) {
                // If resolved and current team is the winner, show success message and redirect
                if (data.winner_team_id === {{ current_user.team.id }}) {
                    // If there's another tiebreaker, go there
                    if (data.next_tiebreaker_id) {
                        window.location.href = '/team_bulk_tiebreaker/' + data.next_tiebreaker_id;
                    } else {
                        // Otherwise go to dashboard with success message
                        window.location.href = '{{ url_for("dashboard") }}?player_won={{ tiebreaker.player.name }}';
                    }
                } else {
                    // If not the winner, check for next tiebreaker or go to bulk round
                    if (data.next_tiebreaker_id) {
                        window.location.href = '/team_bulk_tiebreaker/' + data.next_tiebreaker_id;
                    } else {
                        window.location.href = '{{ url_for("team_bulk_round") }}';
                    }
                }
            } else {
                // If not resolved, continue checking
                setTimeout(checkTiebreakerStatus, 10000);
            }
        })
        .catch(error => {
            console.error('Error checking tiebreaker status:', error);
            // Continue checking even if there's an error
            setTimeout(checkTiebreakerStatus, 10000);
        });
    }
    
    // Start checking tiebreaker status and refresh competing teams
    checkTiebreakerStatus();
    refreshCompetingTeams();
    addNotificationControls(); // Add the notification controls to the UI
</script>
{% endblock %} 