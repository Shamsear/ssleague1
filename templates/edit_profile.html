{% extends "base.html" %}
{% block title %}Edit Profile{% endblock %}

{% block content %}
<div class="container mx-auto mt-8 px-4">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-8">Edit Profile</h1>
        
        <!-- Flash messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    {% set alert_class = 'bg-red-100 border-red-400 text-red-700' if category == 'error' else 'bg-green-100 border-green-400 text-green-700' %}
                    <div class="{{ alert_class }} px-4 py-3 rounded border mb-4" role="alert">
                        <span class="block sm:inline">{{ message }}</span>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <!-- Profile Edit Form -->
        <div class="bg-white shadow-md rounded-lg p-6">
            <form method="POST" enctype="multipart/form-data" class="space-y-8">
                <!-- Current Password (Required for any change) -->
                <div>
                    <label for="current_password" class="block text-sm font-medium text-gray-700 mb-2">Current Password <span class="text-red-500">*</span></label>
                    <input type="password" id="current_password" name="current_password" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Enter your current password to make changes">
                    <p class="text-sm text-gray-500 mt-1">Required to authenticate any profile changes</p>
                </div>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <!-- User Account Section -->
                    <div class="space-y-6">
                        <h3 class="text-lg font-semibold text-gray-900 border-b pb-2">Account Information</h3>
                        
                        <!-- Username -->
                        <div>
                            <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                            <input type="text" id="username" name="username" value="{{ current_user.username }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="Enter new username (optional)">
                            <p class="text-sm text-gray-500 mt-1">Leave blank to keep current username</p>
                        </div>
                        
                        <!-- Password Change Section -->
                        <div class="border-t pt-6">
                            <h4 class="text-md font-medium text-gray-900 mb-4">Change Password</h4>
                            
                            {% if not can_change_password %}
                            <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm">You can only change your password once per day. Try again in {{ time_until_change }}.</p>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            <div class="space-y-4">
                                <div>
                                    <label for="new_password" class="block text-sm font-medium text-gray-700 mb-2">New Password</label>
                                    <input type="password" id="new_password" name="new_password" 
                                           {% if not can_change_password %}disabled{% endif %}
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent {% if not can_change_password %}bg-gray-100{% endif %}"
                                           placeholder="Enter new password (optional)">
                                    <p class="text-sm text-gray-500 mt-1">Minimum 6 characters. Leave blank to keep current password.</p>
                                </div>
                                
                                <div>
                                    <label for="confirm_password" class="block text-sm font-medium text-gray-700 mb-2">Confirm New Password</label>
                                    <input type="password" id="confirm_password" name="confirm_password" 
                                           {% if not can_change_password %}disabled{% endif %}
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent {% if not can_change_password %}bg-gray-100{% endif %}"
                                           placeholder="Confirm new password">
                                </div>
                            </div>
                            
                            {% if last_password_change %}
                            <p class="text-sm text-gray-500 mt-4">Last password change: {{ last_password_change.strftime('%Y-%m-%d %H:%M:%S') }} UTC</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Team Information Section -->
                    <div class="space-y-6">
                        <h3 class="text-lg font-semibold text-gray-900 border-b pb-2">Team Information</h3>
                        
                        <!-- Team Name -->
                        <div>
                            <label for="team_name" class="block text-sm font-medium text-gray-700 mb-2">Team Name</label>
                            <input type="text" id="team_name" name="team_name" value="{{ team.name if team else '' }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="Enter new team name (optional)">
                            <p class="text-sm text-gray-500 mt-1">Leave blank to keep current team name</p>
                        </div>
                        
                        <!-- Current Team Logo -->
                        {% if team and team.logo_url %}
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Current Team Logo</label>
                            <div class="flex items-center space-x-4">
                                <img src="{{ get_team_logo_url(team) }}" alt="{{ team.name }} logo" 
                                     class="w-16 h-16 object-contain border border-gray-300 rounded">
                                <div>
                                    <p class="text-sm text-gray-600">Current logo</p>
                                    <p class="text-xs text-gray-500">Storage: {{ team.logo_storage_type or 'local' }}</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Team Logo Upload -->
                        <div>
                            <label for="team_logo" class="block text-sm font-medium text-gray-700 mb-2">Team Logo</label>
                            <input type="file" id="team_logo" name="team_logo" accept="image/*"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <p class="text-sm text-gray-500 mt-1">Upload a new team logo (PNG, JPG, JPEG, GIF, WEBP). Leave blank to keep current logo.</p>
                            <p class="text-xs text-gray-400 mt-1">Recommended size: 256x256 pixels or similar square aspect ratio</p>
                        </div>
                        
                        <!-- Team Stats (Read-only info) -->
                        {% if team %}
                        <div class="border-t pt-6">
                            <h4 class="text-md font-medium text-gray-900 mb-4">Team Stats</h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-600">Balance:</span>
                                    <span class="font-medium">Â£{{ "{:,}".format(team.balance) }}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Players:</span>
                                    <span class="font-medium">{{ team.players|length }}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Created:</span>
                                    <span class="font-medium">{{ team.created_at.strftime('%Y-%m-%d') if team.created_at else 'Unknown' }}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Team ID:</span>
                                    <span class="font-medium">#{{ team.id }}</span>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Submit Button -->
                <div class="flex justify-between items-center pt-6 border-t">
                    <a href="{{ url_for('dashboard') }}" class="text-gray-600 hover:text-gray-800 underline">Cancel</a>
                    <button type="submit" class="bg-blue-600 text-white px-8 py-3 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors font-medium">
                        Update Profile
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Security Info -->
        <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <div class="ml-3 text-sm text-blue-700">
                    <p><strong>Security Notice:</strong> If you change your password, you will be logged out automatically and need to log in again with your new password. All profile changes require your current password for security.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Client-side validation -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const newPasswordInput = document.getElementById('new_password');
    const confirmPasswordInput = document.getElementById('confirm_password');
    const logoInput = document.getElementById('team_logo');
    
    function validatePasswords() {
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        
        if (newPassword && confirmPassword && newPassword !== confirmPassword) {
            confirmPasswordInput.setCustomValidity('Passwords do not match');
            return false;
        } else {
            confirmPasswordInput.setCustomValidity('');
            return true;
        }
    }
    
    function validateLogo() {
        const file = logoInput.files[0];
        if (file) {
            const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/webp'];
            const maxSize = 5 * 1024 * 1024; // 5MB
            
            if (!allowedTypes.includes(file.type)) {
                alert('Please select a valid image file (PNG, JPG, JPEG, GIF, or WEBP)');
                logoInput.value = '';
                return false;
            }
            
            if (file.size > maxSize) {
                alert('Logo file size must be less than 5MB');
                logoInput.value = '';
                return false;
            }
        }
        return true;
    }
    
    newPasswordInput.addEventListener('input', validatePasswords);
    confirmPasswordInput.addEventListener('input', validatePasswords);
    logoInput.addEventListener('change', validateLogo);
    
    form.addEventListener('submit', function(e) {
        if (!validatePasswords()) {
            e.preventDefault();
            return false;
        }
        
        if (!validateLogo()) {
            e.preventDefault();
            return false;
        }
        
        const newPassword = newPasswordInput.value;
        if (newPassword && newPassword.length < 6) {
            alert('Password must be at least 6 characters long');
            e.preventDefault();
            return false;
        }
        
        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Updating...';
    });
});
</script>
{% endblock %}
