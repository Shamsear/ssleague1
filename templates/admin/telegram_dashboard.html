{% extends "base.html" %}

{% block title %}Telegram Notifications Dashboard - Admin{% endblock %}

{% block extra_css %}
<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-left: 4px solid #007bff;
    }
    
    .stat-card.danger {
        border-left-color: #dc3545;
    }
    
    .stat-card.success {
        border-left-color: #28a745;
    }
    
    .stat-card.warning {
        border-left-color: #ffc107;
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: #333;
    }
    
    .stat-label {
        color: #666;
        margin-top: 5px;
    }
    
    .bot-status {
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: #dc3545;
    }
    
    .status-indicator.active {
        background-color: #28a745;
    }
    
    .status-indicator.warning {
        background-color: #ffc107;
    }
    
    .quick-actions {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .recent-notifications {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .notification-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
    }
    
    .notification-item:last-child {
        border-bottom: none;
    }
    
    .notification-status {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .notification-status.sent {
        background-color: #d4edda;
        color: #155724;
    }
    
    .notification-status.failed {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .notification-status.pending {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .preferences-chart {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }
    
    .preference-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
    }
    
    .test-notification-form {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
    }
    
    .notification-results {
        margin-top: 15px;
        padding: 15px;
        border-radius: 8px;
        display: none;
    }
    
    .notification-results.success {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }
    
    .notification-results.error {
        background-color: #f8d7da;
        border: 1px solid #f1b0b7;
        color: #721c24;
    }
    
    .loading {
        display: none;
        text-align: center;
        margin: 20px 0;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 2s linear infinite;
        margin: 0 auto;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .auto-refresh {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }
    
    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        border-radius: 8px;
        width: 80%;
        max-width: 600px;
    }
    
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    
    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Telegram Notifications Dashboard</h1>
        <div class="auto-refresh">
            <label>
                <input type="checkbox" id="autoRefresh" checked>
                Auto-refresh every 30s
            </label>
            <button class="btn btn-sm btn-outline-primary" onclick="refreshStats()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Statistics Overview -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number" id="totalUsers">{{ total_users }}</div>
            <div class="stat-label">Total Users</div>
        </div>
        
        <div class="stat-card success">
            <div class="stat-number" id="linkedUsers">{{ linked_users }}</div>
            <div class="stat-label">Telegram Linked Users</div>
        </div>
        
        <div class="stat-card success">
            <div class="stat-number" id="activeLinked">{{ active_linked }}</div>
            <div class="stat-label">Active Linked Users</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-number" id="totalNotifications">{{ total_notifications }}</div>
            <div class="stat-label">Total Notifications Sent</div>
        </div>
        
        <div class="stat-card warning">
            <div class="stat-number" id="todayNotifications">{{ today_notifications }}</div>
            <div class="stat-label">Notifications Today</div>
        </div>
        
        <div class="stat-card {% if failed_notifications > 0 %}danger{% endif %}">
            <div class="stat-number" id="failedNotifications">{{ failed_notifications }}</div>
            <div class="stat-label">Failed Notifications</div>
        </div>
    </div>

    <!-- Bot Status -->
    <div class="quick-actions">
        <h3>Bot Status & Quick Actions</h3>
        <div class="row">
            <div class="col-md-6">
                <h5>Telegram Bot Status</h5>
                <div class="bot-status">
                    <span class="status-indicator {% if bot_status.available and bot_status.token_valid %}active{% elif bot_status.available %}warning{% endif %}"></span>
                    <span>
                        {% if bot_status.available and bot_status.token_valid %}
                            Bot Active - @{{ bot_status.username }}
                        {% elif bot_status.available %}
                            Bot Configuration Issue
                        {% else %}
                            Bot Not Available
                        {% endif %}
                    </span>
                </div>
                
                <div class="mt-3">
                    <small class="text-muted">
                        Webhook: 
                        {% if bot_status.webhook_configured %}
                            <span class="text-success">Configured</span>
                        {% else %}
                            <span class="text-warning">Not Configured</span>
                        {% endif %}
                    </small>
                </div>
            </div>
            
            <div class="col-md-6">
                <h5>Quick Actions</h5>
                <div class="btn-group-vertical d-grid gap-2">
                    <a href="{{ url_for('admin_telegram.telegram_users') }}" class="btn btn-primary">
                        <i class="fas fa-users"></i> Manage Users
                    </a>
                    <button class="btn btn-info" onclick="showTestNotificationModal()">
                        <i class="fas fa-paper-plane"></i> Send Test Notification
                    </button>
                    <a href="{{ url_for('admin_telegram.telegram_settings') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-cog"></i> Settings
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Preferences Statistics -->
    <div class="recent-notifications">
        <h3>User Notification Preferences</h3>
        <div class="preferences-chart">
            <div class="preference-item">
                <strong>{{ preference_stats.login }}</strong>
                <div>Login Notifications</div>
            </div>
            <div class="preference-item">
                <strong>{{ preference_stats.bids }}</strong>
                <div>Bid Notifications</div>
            </div>
            <div class="preference-item">
                <strong>{{ preference_stats.auction_start }}</strong>
                <div>Auction Start</div>
            </div>
            <div class="preference-item">
                <strong>{{ preference_stats.auction_end }}</strong>
                <div>Auction End</div>
            </div>
            <div class="preference-item">
                <strong>{{ preference_stats.team_changes }}</strong>
                <div>Team Changes</div>
            </div>
            <div class="preference-item">
                <strong>{{ preference_stats.admin_actions }}</strong>
                <div>Admin Actions</div>
            </div>
            <div class="preference-item">
                <strong>{{ preference_stats.system_alerts }}</strong>
                <div>System Alerts</div>
            </div>
        </div>
    </div>

    <!-- Recent Notifications -->
    <div class="recent-notifications mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>Recent Notifications</h3>
            <small class="text-muted">Last 10 notifications</small>
        </div>
        
        {% if recent_notifications %}
            {% for notification in recent_notifications %}
            <div class="notification-item">
                <div>
                    <strong>{{ notification.notification_type|title }}</strong>
                    {% if notification.telegram_user %}
                        to {{ notification.telegram_user.user.username }}
                    {% endif %}
                    <br>
                    <small class="text-muted">{{ notification.created_at.strftime('%Y-%m-%d %H:%M:%S UTC') }}</small>
                </div>
                <div class="notification-status {{ notification.status }}">
                    {{ notification.status|title }}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="text-center text-muted py-4">
                <i class="fas fa-bell-slash fa-2x mb-2"></i>
                <p>No notifications sent yet</p>
            </div>
        {% endif %}
    </div>

    <!-- Notification Type Breakdown -->
    {% if notification_types %}
    <div class="recent-notifications mt-4">
        <h3>Notification Types Breakdown</h3>
        <div class="preferences-chart">
            {% for notification_type, count in notification_types %}
            <div class="preference-item">
                <strong>{{ count }}</strong>
                <div>{{ notification_type|replace('_', ' ')|title }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Test Notification Modal -->
<div id="testNotificationModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="hideTestNotificationModal()">&times;</span>
        <h2>Send Test Notification</h2>
        
        <form id="testNotificationForm">
            <div class="mb-3">
                <label for="testMessage" class="form-label">Message</label>
                <textarea class="form-control" id="testMessage" rows="4" 
                         placeholder="Enter your test notification message..."></textarea>
            </div>
            
            <div class="mb-3">
                <label for="notificationType" class="form-label">Notification Type</label>
                <select class="form-select" id="notificationType">
                    <option value="system_alerts">System Alerts</option>
                    <option value="admin_actions">Admin Actions</option>
                    <option value="auction_start">Auction Start</option>
                    <option value="auction_end">Auction End</option>
                    <option value="bids">Bids</option>
                    <option value="team_changes">Team Changes</option>
                </select>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Target Users</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="targetUsers" id="testModeOnly" value="test" checked>
                    <label class="form-check-label" for="testModeOnly">
                        Send only to me (test mode)
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="targetUsers" id="allUsers" value="all">
                    <label class="form-check-label" for="allUsers">
                        Send to all users with this notification type enabled
                    </label>
                </div>
            </div>
            
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button type="button" class="btn btn-secondary" onclick="hideTestNotificationModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Send Test Notification</button>
            </div>
        </form>
        
        <div class="loading" id="testLoading">
            <div class="spinner"></div>
            <p>Sending notification...</p>
        </div>
        
        <div class="notification-results" id="testResults"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let autoRefreshInterval;

document.addEventListener('DOMContentLoaded', function() {
    // Setup auto-refresh
    const autoRefreshCheckbox = document.getElementById('autoRefresh');
    autoRefreshCheckbox.addEventListener('change', function() {
        if (this.checked) {
            startAutoRefresh();
        } else {
            stopAutoRefresh();
        }
    });
    
    if (autoRefreshCheckbox.checked) {
        startAutoRefresh();
    }
    
    // Setup test notification form
    document.getElementById('testNotificationForm').addEventListener('submit', sendTestNotification);
});

function startAutoRefresh() {
    autoRefreshInterval = setInterval(refreshStats, 30000); // 30 seconds
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
}

function refreshStats() {
    fetch('/admin/telegram/stats/api')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error fetching stats:', data.error);
                return;
            }
            
            // Update statistics
            document.getElementById('totalUsers').textContent = data.total_users;
            document.getElementById('linkedUsers').textContent = data.linked_users;
            document.getElementById('activeLinked').textContent = data.active_linked;
            document.getElementById('totalNotifications').textContent = data.total_notifications;
            document.getElementById('todayNotifications').textContent = data.today_notifications;
            document.getElementById('failedNotifications').textContent = data.failed_notifications;
            
            // Update failed notifications card style
            const failedCard = document.getElementById('failedNotifications').closest('.stat-card');
            if (data.failed_notifications > 0) {
                failedCard.classList.add('danger');
            } else {
                failedCard.classList.remove('danger');
            }
        })
        .catch(error => {
            console.error('Error refreshing stats:', error);
        });
}

function showTestNotificationModal() {
    document.getElementById('testNotificationModal').style.display = 'block';
}

function hideTestNotificationModal() {
    document.getElementById('testNotificationModal').style.display = 'none';
    document.getElementById('testNotificationForm').reset();
    document.getElementById('testResults').style.display = 'none';
    document.getElementById('testLoading').style.display = 'none';
}

function sendTestNotification(e) {
    e.preventDefault();
    
    const message = document.getElementById('testMessage').value.trim();
    const notificationType = document.getElementById('notificationType').value;
    const targetUsers = document.querySelector('input[name="targetUsers"]:checked').value;
    
    if (!message) {
        alert('Please enter a message');
        return;
    }
    
    // Show loading
    document.getElementById('testLoading').style.display = 'block';
    document.getElementById('testResults').style.display = 'none';
    
    const requestData = {
        message: message,
        type: notificationType,
        test_mode: targetUsers === 'test',
        users: [] // Empty array means all users for non-test mode
    };
    
    fetch('/admin/telegram/test-notification', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('testLoading').style.display = 'none';
        
        const resultsDiv = document.getElementById('testResults');
        resultsDiv.style.display = 'block';
        
        if (data.success) {
            resultsDiv.className = 'notification-results success';
            resultsDiv.innerHTML = `
                <h4>✅ Test Notification Sent Successfully</h4>
                <p>${data.message}</p>
                <div class="mt-3">
                    <strong>Details:</strong>
                    <ul class="mt-2">
                        ${data.results.details.map(detail => `
                            <li>
                                <strong>${detail.user}</strong> 
                                (${detail.telegram}) - 
                                <span class="badge ${detail.status === 'sent' ? 'bg-success' : 'bg-danger'}">
                                    ${detail.status}
                                </span>
                                ${detail.error ? ` - ${detail.error}` : ''}
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
        } else {
            resultsDiv.className = 'notification-results error';
            resultsDiv.innerHTML = `
                <h4>❌ Failed to Send Test Notification</h4>
                <p>${data.error || 'Unknown error occurred'}</p>
            `;
        }
        
        // Refresh stats after sending test notification
        setTimeout(refreshStats, 1000);
    })
    .catch(error => {
        document.getElementById('testLoading').style.display = 'none';
        
        const resultsDiv = document.getElementById('testResults');
        resultsDiv.style.display = 'block';
        resultsDiv.className = 'notification-results error';
        resultsDiv.innerHTML = `
            <h4>❌ Network Error</h4>
            <p>Failed to send test notification: ${error.message}</p>
        `;
    });
}

// Close modal when clicking outside of it
window.onclick = function(event) {
    const modal = document.getElementById('testNotificationModal');
    if (event.target === modal) {
        hideTestNotificationModal();
    }
}
</script>
{% endblock %}